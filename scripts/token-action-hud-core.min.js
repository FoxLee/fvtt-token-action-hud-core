const y={ID:"token-action-hud-core",NAME:"Token Action HUD"},w=`modules/${y.ID}/templates`,A={action:`${w}/action.hbs`,customStyleForm:`${w}/custom-style-form.hbs`,group:`${w}/group.hbs`,hud:`${w}/hud.hbs`,listGroup:`${w}/list-group.hbs`,settings:`${w}/settings.hbs`,tabGroup:`${w}/tab-group.hbs`,tagDialogGroup:`${w}/tag-dialog-group.hbs`,tagDialogHud:`${w}/tag-dialog-hud.hbs`,tagDialogTopLevelGroup:`${w}/tag-dialog-top-level-group.hbs`},k="|",H={compendiumEntry:"tokenActionHud.compendiumEntry",compendiumMacro:"tokenActionHud.compendiumMacro",compendiumPlaylist:"tokenActionHud.compendiumPlaylist",macro:"tokenActionHud.macro"},S=["compendiumEntry","compendiumMacro","compendiumPlaylist","macro"],C=["JournalEntry","Macro","RollTable"],D={compact:{class:"tah-style-foundry-vtt",file:"tah-compact",primaryColor:"#dddddd",secondaryColor:"#dddddd80",tertiaryColor:"#ff6400"},custom:{class:"tah-style-custom",file:"tah-custom"},dorakoUI:{class:"tah-style-dorako-ui",file:"tah-dorako"},foundryVTT:{class:"tah-style-foundry-vtt-dark",file:"tah-foundry-vtt-dark",primaryColor:"#dddddd",secondaryColor:"#dddddd80",tertiaryColor:"#ff6400"},foundryVttLight:{class:"tah-style-foundry-vtt-light",file:"tah-foundry-vtt-light",primaryColor:"#dddddd",secondaryColor:"#dddddd80",tertiaryColor:"#ff6400"},highContrast:{class:"tah-style-high-contrast",file:"tah-high-contrast",primaryColor:"#ffff00",secondaryColor:"#ffff00",tertiaryColor:"#0C7BDC"},pathfinder:{class:"tah-style-pathfinder",file:"tah-pathfinder"}},I={backgroundColor:{cssProperty:"--tah-background-color",type:String,default:"#00000000"},buttonHeight:{cssProperty:"--tah-button-height-editable",type:Number,default:32},buttonBackgroundColor:{cssProperty:"--tah-button-background-color-editable",type:String,default:"#000000b3"},buttonBorderPrimaryColor:{cssProperty:"--tah-button-border-primary-color-editable",type:String,default:"#0C0C0CFF"},buttonBorderSecondaryColor:{cssProperty:"--tah-button-border-secondary-color-editable",type:String,default:"#060606FF"},buttonTextColor:{cssProperty:"--tah-button-text-color-editable",type:String,default:"#DDDDDDFF"},buttonHoverBorderPrimaryColor:{cssProperty:"--tah-button-hover-border-primary-color-editable",type:String,default:"#FF6400FF"},buttonHoverBorderSecondaryColor:{cssProperty:"--tah-button-hover-border-secondary-color-editable",type:String,default:"#FF0000FF"},buttonHoverBackgroundColor:{cssProperty:"--tah-button-hover-background-color-editable",type:String,default:"#000000B3"},buttonHoverTextColor:{cssProperty:"--tah-button-hover-text-color-editable",type:String,default:"#FFFFFFFF"},buttonToggleActiveBackgroundColor:{cssProperty:"--tah-button-toggle-active-background-color-editable",type:String,default:"#3C0078BF"},buttonToggleActiveBorderPrimaryColor:{cssProperty:"--tah-button-toggle-active-border-primary-color-editable",type:String,default:"#9B8DFFFF"},buttonToggleActiveBorderSecondaryColor:{cssProperty:"--tah-button-toggle-active-border-secondary-color-editable",type:String,default:"#9B8DFFFF"},buttonToggleActiveTextColor:{cssProperty:"--tah-button-toggle-active-text-color-editable",type:String,default:"#FFFFFFFF"},buttonToggleHoverBackgroundColor:{cssProperty:"--tah-button-toggle-hover-background-color-editable",type:String,default:"#3C0078BF"},buttonToggleHoverBorderPrimaryColor:{cssProperty:"--tah-button-toggle-hover-border-primary-color-editable",type:String,default:"#9B8DFFFF"},buttonToggleHoverBorderSecondaryColor:{cssProperty:"--tah-button-toggle-hover-secondary-color-editable",type:String,default:"#9B8DFFFF"},buttonToggleHoverTextColor:{cssProperty:"--tah-button-toggle-hover-text-color-editable",type:String,default:"#FFFFFFFF"},textPrimaryColor:{cssProperty:"--tah-text-primary-color-editable",type:String,default:"#DDDDDDFF"},textSecondaryColor:{cssProperty:"--tah-text-secondary-color-editable",type:String,default:"#DDDDDD80"},textTertiaryColor:{cssProperty:"--tah-text-tertiary-color-editable",type:String,default:"#FF6400FF"},textHoverPrimaryColor:{cssProperty:"--tah-text-hover-primary-color-editable",type:String,default:"#DDDDDDFF"},textHoverSecondaryColor:{cssProperty:"--tah-text-hover-secondary-color-editable",type:String,default:"#DDDDDD80"},textHoverTertiaryColor:{cssProperty:"--tah-text-tertiary-color-editable",type:String,default:"#FF6400FF"}},x={COMPENDIUM:"compendium",CUSTOM:"custom",SYSTEM:"system",SYSTEM_DERIVED:"system-derived"},E={ICON:"fas fa-sd-card",TOOLTIP:"Item Macro"},M={customLayout:{hint:"tokenActionHud.settings.customLayout.hint",name:"tokenActionHud.settings.customLayout.name",inputType:"filePicker",filePickerType:"json",dtype:"String",scope:"world"},exportLayout:{hint:"tokenActionHud.settings.exportLayout.hint",label:"tokenActionHud.settings.exportLayout.label",name:"tokenActionHud.settings.exportLayout.name",inputType:"button",icon:"fa-solid fa-file-export",onClick:"game?.tokenActionHud?.actionHandler?.exportLayout()"},resetLayout:{hint:"tokenActionHud.settings.resetLayout.hint",label:"tokenActionHud.settings.resetLayout.label",name:"tokenActionHud.settings.resetLayout.name",inputType:"button",icon:"fa-solid fa-arrow-rotate-left",onClick:"game?.tokenActionHud?.reset()"}},O={activeCssAsText:{variable:"activeCssAsTextSetting"},allow:{variable:"allowSetting"},alwaysShowHud:{variable:"alwaysShowHudSetting"},backgroundColor:{},buttonBackgroundColor:{},buttonBorderPrimaryColor:{},buttonBorderSecondaryColor:{},buttonHeight:{},buttonHoverBorderPrimaryColor:{},buttonHoverBorderSecondaryColor:{},buttonHoverBackgroundColor:{},buttonHoverTextColor:{},buttonTextColor:{},buttonToggleActiveBackgroundColor:{},buttonToggleActiveBorderPrimaryColor:{},buttonToggleActiveBorderSecondaryColor:{},buttonToggleActiveTextColor:{},buttonToggleHoverBackgroundColor:{},buttonToggleHoverBorderPrimaryColor:{},buttonToggleHoverBorderSecondaryColor:{},buttonToggleHoverTextColor:{},clickOpenCategory:{variable:"clickOpenCategorySetting"},customLayout:{variable:"customLayoutSetting"},customStyle:{},debug:{variable:"debugSetting"},direction:{variable:"directionSetting"},displayCharacterName:{variable:"displayCharacterName"},displayIcons:{variable:"displayIconsSetting"},drag:{variable:"dragSetting"},enable:{variable:"enableSetting"},enableCustomization:{variable:"enableCustomizationSetting"},grid:{variable:"gridSetting"},itemMacro:{},migrationVersion:{},reset:{},renderItemOnRightClick:{},rollHandler:{default:"core"},scale:{variable:"scaleSetting"},startup:{},style:{},tooltips:{variable:"tooltipsSetting"},textPrimaryColor:{},textSecondaryColor:{},textTertiaryColor:{},textHoverPrimaryColor:{},textHoverSecondaryColor:{},textHoverTertiaryColor:{}};class Logger{static info(y,w=!1){w?ui.notifications.info(`Token Action HUD | ${y}`):console.log(`Token Action HUD Info | ${y}`)}static error(y,w=!1){w?ui.notifications.error(`Token Action HUD | ${y}`):console.error(`Token Action HUD Error | ${y}`)}static debug(y,w){if(game.tokenActionHud?game.tokenActionHud.debugSetting:Utils.getSetting("debug")){if(!w)return void console.log(`Token Action HUD Debug | ${y}`);const A=Utils.deepClone(w);console.log(`Token Action HUD Debug | ${y}`,A)}}}class Timer{constructor(y){this.milliseconds=y,this.timer=null}async start(){return this.timer&&this.abort(),new Promise((y=>{this.timer=setTimeout((()=>{y()}),this.milliseconds??100)}))}async abort(){clearTimeout(this.timer),this.timer=null}}class Utils{static checkAllow(y,w){return y>=w}static deepClone(y,w){return deepClone(y,w)}static getActor(y,w){let A=null;return w&&(A=canvas.tokens.placeables.find((y=>y.id===w))),A?A.actor:game.actors.get(y)}static getStatusEffect(y,w){return game.version.startsWith("11")?y.effects.find((y=>y.statuses.every((y=>y===w)))):y.effects.find((y=>y.flags?.core?.statusId===w))}static getImage(y,w=[]){w.push("icons/svg/mystery-man.svg");let A="";return game.tokenActionHud.displayIconsSetting&&(A="string"==typeof y?y:y?.img??y?.icon??""),w.includes(A)?"":A}static getItem(y,w){return y.items.get(w)}static getToken(y){return canvas.tokens.placeables.find((w=>w.id===y))}static getControlledTokens(){return game.canvas.tokens.controlled}static getFirstControlledToken(){const y=game.canvas.tokens.controlled[0];if(y)return y;const w=game.user?.character;return w?canvas.tokens.placeables.find((y=>y.actor?.id===w.id)):void 0}static getSetting(w,A=null){let k=A??null;try{k=game.settings.get(y.ID,w)}catch{Logger.debug(`Setting '${w}' not found`)}return k}static async setSetting(w,A){game.settings.settings.get(`${y.ID}.${w}`)?(await game.settings.set(y.ID,w,A),Logger.debug(`Setting '${w}' set to '${A}'`)):Logger.debug(`Setting '${w}' not found`)}static getActorFlag(w){return game.tokenActionHud.actor.getFlag(y.ID,w)}static async setActorFlag(w,A){await game.tokenActionHud.actor.setFlag(y.ID,w,A)}static async unsetActorFlag(w){await game.tokenActionHud.actor.unsetFlag(y.ID,w)}static getUserFlag(w){return game.user.getFlag(y.ID,w)}static async setUserFlag(w,A){await game.user.setFlag(y.ID,w,A)}static async unsetUserFlag(w){await game.user.unsetFlag(y.ID,w)}static i18n(y){return game.i18n.localize(y)}static isGmActive(){return game.users.some((y=>y.isGM&&y.active))}static isModuleActive(y){const w=game.modules.get(y);return w&&w.active}static getModuleTitle(y){return game.modules.get(y)?.title??""}static getModuleVersion(y){return game.modules.get(y)?.version??""}static humanizeBinding(w){const A=game.keybindings.get(y.ID,w);if(!A)return"";return A[0].modifiers.reduce(((y,w)=>(KeyboardManager.MODIFIER_CODES[w]?.includes(A[0].key)||y.unshift(KeyboardManager.getKeycodeDisplayString(w)),y)),[KeyboardManager.getKeycodeDisplayString(A[0].key)]).join(" + ")}static median(y){const w=Math.floor(y.length/2),A=[...y].sort(((y,w)=>y-w));return y.length%2!=0?A[w]:(A[w-1]+A[w])/2}static getUpperQuartileAverage(y){const w=y.slice().sort(((y,w)=>y-w)),A=w.length,k=A-1;let H=0,S=0;for(let y=Math.ceil(.75*A);y<=k;y++)H+=w[y],S++;return H/S}static getModifier(y){if(!y)return"";return`${y>=0?"+":""}${y}`}static sortItems(y){return new Map([...y.entries()].sort(((y,w)=>y[1].sort.localeCompare(w[1].sort))))}static sortItemsByName(y){return new Map([...y.entries()].sort(((y,w)=>y[1].name.localeCompare(w[1].name))))}static switchCSS(w){for(const[A,k]of Object.entries(D)){const H=[`modules/${y.ID}/`,`styles/${k.file}`];Object.values(document.styleSheets).find((y=>y.href?.includes(H[0])&&y.href?.includes(H[1]))).disabled=A!==w}if("custom"===w)for(const[y,w]of Object.entries(I)){const A=Utils.getSetting(y);A&&document.querySelector(":root").style.setProperty(w.cssProperty,A)}const A=document.querySelector("#token-action-hud");A&&(A.classList.remove(...A.classList),A.classList.add(D[w].class))}static registerHandlebars(){Handlebars.registerHelper("cap",(function(y){return!y||y.length<1?"":y[0].toUpperCase()+y.slice(1)}));const reduceOp=function(y,w){(y=Array.from(y)).pop();const A=y.shift();return y.reduce(w,A)};Handlebars.registerHelper({eq:function(){return reduceOp(arguments,((y,w)=>y===w))},ne:function(){return reduceOp(arguments,((y,w)=>y!==w))},lt:function(){return reduceOp(arguments,((y,w)=>y<w))},gt:function(){return reduceOp(arguments,((y,w)=>y>w))},lte:function(){return reduceOp(arguments,((y,w)=>y<=w))},gte:function(){return reduceOp(arguments,((y,w)=>y>=w))},and:function(){return reduceOp(arguments,((y,w)=>y&&w))},or:function(){return reduceOp(arguments,((y,w)=>y||w))},true:function(){return reduceOp(arguments,(y=>y))},false:function(){return reduceOp(arguments,(y=>!y))}}),Handlebars.registerHelper("activeText",(function(y){return game.tokenActionHud.activeCssAsTextSetting?y.fn(this):y.inverse(this)}))}static getModuleVersionParts(y){if(!y)return void Logger.debug("Module version not retrieved",{trigger:"getModuleVersionParts"});const w=y.split(".");return{major:w[0],minor:w[1],patch:w[2]}}static async checkModuleCompatibility(w){const A=this.getModuleVersionParts(w),k=this.getModuleVersionParts(game.modules.get(y.ID).version);return!(k.major!==A.major||k.minor!==A.minor||A.patch&&k.patch!==A.patch)||(ui.notifications.error(`The installed Token Action HUD system module requires Token Action HUD Core module version ${w}. Install the required version to continue using Token Action HUD.`),!1)}static getSubcategories(y,w={}){let A=0;if(!y)return;const k=w?.id,H=w?.type;y=Array.isArray(y)?y:Object.values(y);const S={};for(const C of y){if(!(k&&C.id!==k||H&&C.type!==H)){A++;const y=C.nestId.split("_").length;S[C.nestId]={...C,order:A,level:y}}if(C.subcategories?.length>0){const y=this.getSubcategories(C.subcategories,w);y&&Object.assign(S,y)}}return Object.keys(S).length>0?S:null}static getNestedGroups(y,w={}){let A=0;if(!y)return;const k=w?.id,H=w?.type;y=Array.isArray(y)?y:Object.values(y);const S={};for(const C of y){if(!(k&&C.id!==k||H&&C.type!==H)){A++;const y=C.nestId.split("_").length;S[C.nestId]={...C,order:A,level:y}}if(C.groups?.length>0){const y=this.getNestedGroups(C.groups,w);y&&Object.assign(S,y)}}return Object.keys(S).length>0?S:null}static async getGroupByNestId(y,w={}){const A="string"==typeof w?w:w?.nestId,k=w?.type;if(!A)return;const H=A.split("_");return await async function findGroup(y,w){y=Array.isArray(y)?y:Object.values(y);for(const A of y)if(A.id===w[0]){if(1===w.length)return A.type&&k&&A.type!==k?void 0:A;w.shift();for(const y of Object.values(A.groups)){if(0===y.length)continue;const A=await findGroup(y,w);if(A)return A}}}(y,H)}static async deleteGroupByNestId(y,w={}){const A="string"==typeof w?w:w?.nestId;if(!A)return;const k=A.split("_");return await async function findGroup(y,w){y=Array.isArray(y)?y:Object.values(y);for(const[A,k]of y.entries())if(k.id===w[0]){if(1===w.length)return void y.splice(A,1);if(0===k.groups.length)return;w.shift();if(await findGroup(k.groups,w))return}}(y,k)}static async deleteGroupsById(y,w={}){const A="string"==typeof w?w:w?.id;if(A)for(let k=y.length-1;k>=0;k--)y[k].id===A?y.splice(k,1):y[k].groups?.length>0&&this.deleteGroupsById(y[k].groups,w)}}class CategoryResizer{direction=null;minCols=3;isCustomWidth=!1;settings=null;spacing=10;async resizeCategory(y,w,A,k){if(!w)return;if(this._resetVariables(),this.groupElement=w,await this._getGroupsElement(),!this.groupsElement)return;if(this.actionsElements=this.groupElement.querySelectorAll(".tah-actions"),0===this.actionsElements.length)return;this._resetGroupsElements(),this.direction=A;const H=this.groupElement.dataset.nestId;this.settings=await y.getGroupSettings({nestId:H,level:1}),this.availableWidth=this._getAvailableWidth(),this._getGroupElements();let S=!1;for(const w of this.groupElements){const A=w.querySelector(".tah-actions");if(!A)continue;const H=w.dataset.nestId,C=await y.getGroupSettings({nestId:H});k||this.settings?.grid||C?.grid?(S||(await this._getGridWidth(),S=!0),await this._resizeGrid(A)):await this._resize(A)}await this._setHeight()}_resetVariables(){this.actionsElements=null,this.availableHeight=null,this.availableWidth=null,this.direction=null,this.gridWidth=null,this.groupElement=null,this.groupElements=null,this.groupsElement=null,this.groupsElementPadding=null,this.groupsElementRect=null,this.isCustomWidth=!1,this.minCols=3,this.settings=null,this.spacing=10}_resetGroupsElements(){const y=this.groupElement.closest('.tah-tab-group[data-level="1"]').querySelectorAll(".tah-groups");this._resetCSS(y,{maxHeight:"",overflowY:""})}async _getGridWidth(){await this._resetCSS(this.actionsElements,{display:"",gridTemplateColumns:"",width:""});const y=[],w=[];for(const A of this.actionsElements){const k=A.querySelectorAll(".tah-action:not(.shrink)");for(const A of k){const k=A.getBoundingClientRect(),H=Math.round(parseFloat(k.width)+1||0),S=A.querySelector(".tah-action-button-text"),C=S?.getBoundingClientRect(),D=Math.round(parseFloat(C?.width)||0);w.push(H),y.push({actionWidth:H,actionButtonTextWidth:D})}}let A=Math.ceil(Utils.getUpperQuartileAverage(w));for(const w of y){const y=A-(w.actionWidth-w.actionButtonTextWidth);y<30&&(A=A-y+30)}this.gridWidth=A}async _resizeGrid(y){if(!y)return;await this._assignCSS(y,{display:"",gridTemplateColumns:"",width:""});const w=y.querySelectorAll(".tah-action"),A=Math.ceil(Math.sqrt(w.length)),k=Math.floor(this.availableWidth/this.gridWidth),H={display:"grid",gridTemplateColumns:`repeat(${A>k?k:w.length<=this.minCols?w.length:A}, ${this.gridWidth}px)`};await this._assignCSS(y,H)}async _resize(y){if(!y)return;let w=500;if(this.isCustomWidth)w=this.availableWidth;else{const A=y.querySelectorAll(".tah-action");if(!A.length)return;const k=Math.ceil(Math.sqrt(A.length));let H=1,S=0,C=0;A.length>0&&A.forEach(((y,w)=>{(w+1)/k>H&&(C-=5,S=C>S?C:S,C=0,H++);const D=y.getBoundingClientRect(),I=Math.ceil(parseFloat(D.width)+1||0);C+=I,w+1===A.length&&(C-=5,S=C>S?C:S)})),S+=this.groupsElementPadding,w=S<this.availableWidth&&A.length>3?S:this.availableWidth,w<200&&(w=200)}const A={maxWidth:`${w}px`};await this._assignCSS(y,A)}_getAvailableWidth(){const y=this.settings?.customWidth;if(y)return this.isCustomWidth=!0,y;const w=canvas.screenDimensions[0],A=this.groupsElementRect.left,k=document.querySelector("#ui-right").clientWidth;return Math.floor((k>0?w-k:w)-this.spacing-A)}_getAvailableHeight(){const y=canvas.screenDimensions[1],w=this.groupsElementRect.bottom,A=this.groupsElementRect.top,k=("down"===this.direction?document.querySelector("#ui-bottom"):document.querySelector("#ui-top")).offsetHeight,H="down"===this.direction?y-A-k-this.spacing:w-k-this.spacing;return Math.floor(H<100?100:H)}async _getGroupsElement(){this.groupsElement=this.groupElement.querySelector(".tah-groups"),this.groupsElement&&(this.groupsElementRect=this.groupsElement.getBoundingClientRect(),this.groupsElementComputed=getComputedStyle(this.groupsElement),this.groupsElementPadding=Math.ceil(parseFloat(this.groupsElementComputed.paddingLeft)||0)+Math.ceil(parseFloat(this.groupsElementComputed.paddingRight)||0))}_getGroupElements(){this.groupElements=this.groupElement.querySelectorAll(".tah-group"),0===this.groupElements.length&&(this.groupElements=[this.groupElement])}async _setHeight(){requestAnimationFrame((()=>{this.availableHeight=this._getAvailableHeight();const y={maxHeight:`${this.availableHeight}px`,overflowY:"auto"};Object.assign(this.groupsElement.style,y)}))}async _assignCSS(y,w){y&&requestAnimationFrame((()=>{Object.assign(y.style,w)}))}async _resetCSS(y,w){for(const A of y)Object.assign(A.style,w)}}class DataHandler{static isPersistentStorage(){return game.version>="11.305"&&"undefined"==typeof ForgeVTT}static async createDirectories(){const w="data",A=DataHandler.isPersistentStorage()?`modules/${y.ID}/storage`:y.ID;await FilePicker.browse(w,A).catch((async y=>{await FilePicker.createDirectory(w,A,{})||Logger.debug("Failed to create directory: "+A)}));const k=`${A}/${game.world.id}`;await FilePicker.browse(w,k).catch((async y=>{await FilePicker.createDirectory(w,k,{})||Logger.debug("Failed to create directory: "+k)}));const H=`${k}/actor`;await FilePicker.browse(w,H).catch((async y=>{await FilePicker.createDirectory(w,H,{})||Logger.debug("Failed to create directory: "+H)}));const S=`${k}/user`;await FilePicker.browse(w,S).catch((async y=>{await FilePicker.createDirectory(w,S,{})||Logger.debug("Failed to create directory: "+S)}))}static async saveDataAsGm(y,w,A){Utils.isGmActive()?await game.tokenActionHud.socket.executeAsGM("saveData",y,w,A):Logger.info("Cannot save data without a GM present",!0)}static async saveData(w,A,k){const H=DataHandler.isPersistentStorage()?`modules/${y.ID}/storage/${game.world.id}/${w}`:`${y.ID}/${game.world.id}/${w}`,S=encodeURI(`${A}.json`),C=new File([JSON.stringify(k,null,"")],S,{type:"application/json"}),D=await FilePicker.upload("data",H,C,{},{notify:!1});D.path||Logger.debug(`Failed to save data to: ${S}\nReason: ${D}`)}static async getDataAsGm(y){if(Utils.isGmActive())return await game.tokenActionHud.socket.executeAsGM("getData",y);Logger.info("Cannot get data without a GM present",!0)}static async getData(w){const{file:A,type:k,id:H}=w;let S,C;A?({folder:S,fileName:C}=function getFileParts(y){const w=y.split("/"),A=w[w.length-1];return{folder:y.split("/").slice(0,-1).join("/")??"",fileName:A}}(A)):(S=DataHandler.isPersistentStorage()?`modules/${y.ID}/storage/${game.world.id}/${k}`:`${y.ID}/${game.world.id}/${k}`,C=encodeURI(`${H}.json`));try{const y=(await FilePicker.browse("data",S)).files.find((y=>y.endsWith(C)));if(y){const w=Date.now();return await fetch(`${y}?ms=${w}`).then((y=>y.ok?y.json():null)).catch((y=>{console.error(y)}))}return null}catch{return null}}getFileParts(y){const w=y.split("/"),A=w[w.length-1];return{folder:y.split("/").slice(0,-1).join("/"),filename:A}}static async saveDataMigrate(w,A,k){const H=`${y.ID}/${game.world.id}/${w}`,S=encodeURI(`${A}.json`),C=new File([JSON.stringify(k,null,"")],S,{type:"application/json"}),D=await FilePicker.upload("data",H,C,{},{notify:!1});D.path||Logger.debug(`Failed to save data to: ${S}\nReason: ${D}`)}static async getDataMigrate(w,A){const k=`${y.ID}/${game.world.id}/${w}`,H=encodeURI(`${A}.json`);try{const y=(await FilePicker.browse("data",k)).files.find((y=>y.endsWith(H)));if(y){const w=Date.now();return await fetch(`${y}?ms=${w}`).then((y=>y.ok?y.json():null)).catch((y=>{console.error(y)}))}return null}catch{return null}}}class GenericActionHandler{actionHandler;constructor(y){this.actionHandler=y,this.actor=y.actor,this.token=y.token}buildGenericActions(){this.#t()}#t(){if(this.actor)return this.#e();this.#i()}#e(){if(!this.token)return;const y=[],w="utility",A="toggleCombat",H=this.token?.inCombat?Utils.i18n("tokenActionHud.removeFromCombat"):Utils.i18n("tokenActionHud.addToCombat"),S=[w,A].join(k),C={id:A,name:H,encodedValue:S};if(y.push(C),game.user.isGM){const A="toggleVisibility",H=this.token?.document?.hidden?Utils.i18n("tokenActionHud.makeVisible"):Utils.i18n("tokenActionHud.makeInvisible"),S=[w,A].join(k),C={id:A,name:H,encodedValue:S};y.push(C)}const D={id:"token",type:x.SYSTEM};this.actionHandler.addActions(y,D)}#i(){const y=Utils.getControlledTokens(),w=[],A="utility",H="toggleCombat",S=y.every((y=>y.inCombat))?Utils.i18n("tokenActionHud.removeFromCombat"):Utils.i18n("tokenActionHud.addToCombat"),C=[A,H].join(k),D={id:H,name:S,encodedValue:C};if(w.push(D),game.user.isGM){const H="toggleVisibility",S=y.every((y=>y.document?.hidden))?Utils.i18n("tokenActionHud.makeVisible"):Utils.i18n("tokenActionHud.makeInvisible"),C=[A,H].join(k),D={id:H,name:S,encodedValue:C};w.push(D)}const I={id:"token",type:x.SYSTEM};this.actionHandler.addActions(w,I)}}class CompendiumActionHandler{actionHandler;constructor(y){this.actionHandler=y}async buildCompendiumActions(){const y=game.packs.filter((y=>C.includes(y.documentName)&&(game.version.startsWith("11")?y.visible:!y.private||game.user.isGM))).map((y=>y.metadata.id));for(const w of y){const y=await this._getCompendiumActions(w),A={id:w.replace(".","-"),type:"core"};this.actionHandler.addActions(y,A)}}async _getCompendiumActions(y){const w=await this._getCompendiumEntries(y),A=this._getCompendiumActionType(y);return w.map((w=>{const S=w._id,C=w.name,D=`${`${Utils.i18n(H[A])}: `??""}${C}`;return{id:S,name:C,encodedValue:[A,y,w._id].join(k),img:Utils.getImage(w),listName:D}}))}async _getCompendiumEntries(y){const w=game.packs.get(y);if(!w)return[];const A=w.index.size>0?w.index:await w.getIndex();if("Playlist"===w.documentName){return await this._getPlaylistEntries(w)}return A}async _getPlaylistEntries(y){return(await y.getContent()).reduce(((y,w)=>(w.sounds.forEach((A=>{y.push({_id:`${w._id}>${A._id}`,name:A.name})})),y)),[])}_getCompendiumActionType(y){const w=game?.packs?.get(y);if(!w)return"";switch(w.documentName){case"Macro":return"compendiumMacro";case"Playlist":return"compendiumPlaylist";default:return"compendiumEntry"}}}class MacroActionHandler{actionHandler;constructor(y){this.actionHandler=y}async buildMacroActions(){const y=await this._getActions();this.actionHandler.addActions(y,{id:"macros",type:"core"})}async _getActions(){const y="macro";return game.macros.filter((y=>{const w=y.ownership;return w[game.userId]?w[game.userId]>0:w.default>0})).map((w=>{const A=w.id,S=w.name;return{id:A,name:S,listName:`${`${Utils.i18n(H[y])}: `??""}${S}`,encodedValue:[y,w.id].join(k),img:Utils.getImage(w)}}))}}class ActionHandler{characterName=null;actor=null;token=null;furtherActionHandlers=[];delimiter=k;constructor(){this.genericActionHandler=new GenericActionHandler(this),this.compendiumActionHandler=new CompendiumActionHandler(this),this.macroActionHandler=new MacroActionHandler(this),this.hud=[],this.defaultGroups={},this.defaultLayout={},this.groups={},this.actorGroups={},this.userGroups={},this.actions=[],this.availableActions=[],this.customLayoutSetting=Utils.getSetting("customLayout"),this.enableCustomizationSetting=Utils.getSetting("enableCustomization"),this.displayCharacterNameSetting=Utils.getSetting("displayCharacterName"),this.tooltipsSetting=Utils.getSetting("tooltips")}softResetActionHandler(){this.genericActionHandler=new GenericActionHandler(this),this.compendiumActionHandler=new CompendiumActionHandler(this),this.macroActionHandler=new MacroActionHandler(this),this.hud=[],this.defaultGroups={},this.defaultLayout={},this.groups={},this.actions=[],this.availableActions=[]}hardResetActionHandler(){this.softResetActionHandler(),this.actorGroups={},this.userGroups={}}async registerDefaultCategories(){}async buildHud(y){return Logger.debug("Building HUD...",{actor:this.actor,token:this.token}),this.previousActor?.id===this.actor?.id?this.isSameActor=!0:(this.previousActor=this.actor,this.isSameActor=!1),this.softResetActionHandler(),await this.#s(),await this.#o(),await this.#n(),this.isGmActive=Utils.isGmActive(),this.isGmActive||this.isGmInactiveUserNotified||(Logger.info("Cannot retrieve HUD layout without GM present",!0),this.isGmInactiveUserNotified=!0),await this.#a(),this.actor&&await this.#r(),this.hud=await this.#l(),await Promise.all([this.#d(),this.#c(),this.#g(),this.#u()]),await this.buildFurtherActions(),await this.#h(),await this.#p(),await this.#m(),await this.#f(),await this.saveGroups(y),Logger.debug("HUD built",{hud:this.hud,actor:this.actor,token:this.token}),this.hud}async#l(){Logger.debug("Preparing HUD...",{actor:this.actor,token:this.token});const y=this.displayCharacterNameSetting?this.characterName??"Multiple":"",w=this.actor?.id??"multi",A={title:y,tokenId:this.token?.id??"multi",actorId:w,groups:[]};if(Object.keys(this.userGroups).length){const y=this.#y();for(const w of y)if(1===w.level){const y=this.#v(w);A.groups.push(y),this.groups[y.nestId]=y}else{const y=w.nestId.split("_",w.level-1).join("_"),k=await Utils.getGroupByNestId(A.groups,{nestId:y});if(k){const y=this.#v(w);"tab"===y.settings.style?k.groups.tabs.push(y):k.groups.lists.push(y),this.groups[y.nestId]=y}}}if(Object.keys(this.actorGroups).length){const y=this.#b();for(const w of y){const y=w.nestId.split("_",w.level-1).join("_"),k=await Utils.getGroupByNestId(A.groups,{nestId:w.nestId});if(k){if(w.actions?.length){k.actions=w.actions,this.actions.push(...k.actions);for(const y of k.actions)y.selected=!1}}else{const k=await Utils.getGroupByNestId(A.groups,{nestId:y});if(k&&"system-derived"===w.type){const y=this.#v(w);if(w.actions?.length){y.actions=w.actions,this.actions.push(...y.actions);for(const w of y.actions)w.selected=!1}"tab"===y.settings.style?k.groups.tabs.push(y):k.groups.lists.push(y),this.groups[y.nestId]=y}}}}return Logger.debug("HUD prepared",{hud:A,actor:this.actor,token:this.token}),A}async buildSystemActions(y){}async#d(){Logger.debug("Building system actions...",{actor:this.actor,token:this.token});const y=Object.values(this.groups).map((y=>y.id));await this.buildSystemActions(y),Logger.debug("System actions built",{hud:this.hud,actor:this.actor,token:this.token})}async#g(){Logger.debug("Building compendium actions..."),await this.compendiumActionHandler.buildCompendiumActions(),Logger.debug("Compendium actions built",{hud:this.hud})}#c(){Logger.debug("Building generic actions...",{actor:this.actor,token:this.token}),this.genericActionHandler.buildGenericActions(),Logger.debug("Generic actions built",{hud:this.hud,actor:this.actor,token:this.token})}async#u(){Logger.debug("Building macro actions..."),await this.macroActionHandler.buildMacroActions(),Logger.debug("Macro actions built",{hud:this.hud})}async buildFurtherActions(){this.furtherActionHandlers.forEach((y=>y.extendActionList()))}async#h(){const y=this.actions.filter((y=>!y?.isPreset));for(const w of y){const y=this.availableActions.find((y=>y.id===w.id));if(y){const A=y.systemSelected??w.systemSelected,k=w.userSelected??y.userSelected;Object.assign(w,this.#T({...y,systemSelected:A,userSelected:k}))}}}async#p(){for(const y of Object.values(this.groups))y.actions.some((y=>y.selected))?y.hasActions=!0:y.hasActions=!1}async#s(){const y=game.tokenActionHud.defaults?.groups?.length?game.tokenActionHud.defaults?.groups:game.tokenActionHud.defaults?.subcategories;if(!y)return{};for(const w of y)this.defaultGroups[w.id]=w}async#o(){if(Object.keys(this.defaultLayout).length)return;const y=game.tokenActionHud.defaults?.layout?.length?game.tokenActionHud.defaults?.layout:game.tokenActionHud.defaults?.categories;if(!y)return{};this.defaultLayout=await Utils.getNestedGroups(y)}async#n(){this.customLayoutSetting&&(this.customLayout=await DataHandler.getDataAsGm({file:this.customLayoutSetting})??null)}async exportLayout(){const y=await DataHandler.getDataAsGm({type:"user",id:game.userId})??this.customLayout??this.defaultLayout;y&&saveDataToFile(JSON.stringify(y,null,2),"text/json","token-action-hud-layout.json")}async#r(){if(!this.actor)return;if(!this.enableCustomizationSetting)return void(this.actorGroups={});if(this.isSameActor&&Object.entries(this.actorGroups).length)return;if(!this.isGmActive)return void(this.actorGroups={});Logger.debug("Retrieving groups from actor...",{actor:this.actor}),this.actorGroups={};const y=await DataHandler.getDataAsGm({type:"actor",id:this.actor.id})??null;if(y){for(const w of Object.entries(y))w[1].nestId=w[0];this.actorGroups=y,Logger.debug("Groups from actor retrieved",{actorGroups:this.actorGroups,actor:this.actor})}}async#a(){const y=game.user,w=this.customLayout??this.defaultLayout,getUserGroups=y=>{const A=Object.keys(y).length?y:w;for(const y of Object.entries(A))y[1].nestId=y[0];return A};if(!this.enableCustomizationSetting)return void(this.userGroups=getUserGroups(w));if(Object.entries(this.userGroups).length)return;if(!this.isGmActive)return void(this.userGroups=getUserGroups(w));Logger.debug("Retrieving groups from user...",{user:y}),this.userGroups={};const A=await DataHandler.getDataAsGm({type:"user",id:y.id})??{};this.userGroups=getUserGroups(A),Logger.debug("Groups retrieved from user",{userGroups:this.userGroups,user:y})}#w(y={}){return y?.nestId?this.groups[y.nestId]:Object.values(this.groups).find((w=>!(y.id&&w.id!==y.id||y.type&&w.type!==y.type||y.level&&w.level!==y.level)))}#A(y={}){return Object.values(this.groups).filter((w=>(!y.id||w.id===y.id)&&(!y.nestId||w.nestId.startsWith(y.nestId))&&(!y.type||w.type===y.type)&&(!y.level||w.level===y.level)&&(!y.selected||w.selected===y.selected)))}#b(y={}){return Object.values(this.actorGroups).filter((w=>(!y.id||w.id===y.id)&&(!y.nestId||w.nestId.startsWith(y.nestId))&&(!y.type||w.type===y.type)&&(!y.level||w.level===y.level))).sort(((y,w)=>y.level===w.level?y.order-w.order:y.level-w.level))}#y(y={}){return Object.values(this.userGroups).filter((w=>(!y.id||w.id===y.id)&&(!y.nestId||w.nestId.startsWith(y.nestId))&&(!y.type||w.type===y.type)&&(!y.level||w.level===y.level))).sort(((y,w)=>y.level===w.level?y.order-w.order:y.level-w.level))}async getGroupSettings(y){const w=this.#w(y);return w?.settings??null}async saveGroupSettings(y){const w=this.#w(y);w.settings={...w.settings,...y.settings},this.saveGroups({saveActor:!0,saveUser:!0})}#v(y,w=!1){const A=Utils.deepClone(y);A?.settings||(A.settings={}),void 0===A?.settings?.showTitle&&(A.settings.showTitle=!0),A.subtitleClass=A?.settings?.showTitle?"":"tah-hidden";const k=y.nestId.split("_"),H=k.length??1,S=w?y?.actions??[]:[],C=w?y?.groups??{lists:[],tabs:[]}:{lists:[],tabs:[]},D=this.#k(y?.tooltip,A?.name);return 1===H?(void 0===A?.settings?.style&&(A.settings.style="tab"),{actions:S,cssClass:"",groups:C,id:A?.id,selected:A?.selected??A?.isSelected??A?.defaultSelected??!0,level:A?.level??k.length??1,name:A?.name,nestId:A?.nestId??A?.id,order:A.order,settings:A?.settings??{style:"tab"},tooltip:D,type:"custom"}):(void 0===A?.settings?.style&&(A.settings.style="list"),{id:A?.id,nestId:A?.nestId,name:A?.name,listName:A?.listName,selected:A?.selected??A?.isSelected??A?.defaultSelected??!0,level:A.level??H,order:A.order,settings:A?.settings??{showTitle:!0,style:"list"},tooltip:D,type:A?.type??x.CUSTOM,subtitleClass:A?.subtitleClass??"",info1:A?.info1??"",info2:A?.info2??"",info3:A?.info3??"",actions:S,groups:C})}async updateGroups(y,w){Array.isArray(y)||(y=[y]);const A={level:(w?.level??0)+1};w?.nestId&&(A.nestId=w.nestId);const k=this.#A(A);for(const w of k)"system-derived"===w.type?w.selected=!1:y.find((y=>y.id===w.id))||delete this.groups[w.nestId];let H=0;for(const A of y){A.nestId=w?.nestId?`${w.nestId}_${A.id}`:A.id,A.selected=A.selected??!0,A.order=H;const y=this.#w(A);if(y)Object.assign(y,A);else{const y=this.#v(A);this.groups[A.nestId]=y}H++}if(w?.settings){const y=this.#w(w);y&&(y.settings=w.settings)}}async saveGroups(y={saveActor:!1,saveUser:!1}){this.enableCustomizationSetting&&(Logger.debug("Saving groups..."),y?.saveActor&&await this.#H(),y?.saveUser&&await this.#S(),Logger.debug("Groups saved",{groups:this.groups}))}async#H(){if(!Object.keys(this.groups).length)return;Logger.debug("Saving actor groups...");const y={};this.actorGroups={};for(const w of Object.values(this.groups))this.actorGroups[w.nestId]=w,y[w.nestId]=this.#C(w,!0);Utils.isGmActive()?(await DataHandler.saveDataAsGm("actor",this.actor.id,y),Logger.debug("Actor groups saved",{actorGroups:y})):Logger.debug("Actor groups not saved as no GM present")}async#S(){if(!Object.keys(this.groups).length)return;Logger.debug("Saving user groups...");const y={};this.userGroups={};for(const w of Object.values(this.groups))"system-derived"!==w.type&&(this.userGroups[w.nestId]=w,y[w.nestId]=this.#C(w,!1));Utils.isGmActive()?(await DataHandler.saveDataAsGm("user",game.userId,y),Logger.debug("User groups saved",{userGroups:y})):Logger.debug("User groups not saved as no GM present")}#C(y,w=!1){const A={id:y.id,name:y.name,listName:y.listName,selected:y.selected,level:y.level,order:y.order,settings:y.settings,type:y.type};return w&&(A.actions=y.actions.map((y=>({id:y.id,isPreset:y.isPreset,userSelected:y.userSelected})))),A}#D(y){return this.actions.filter((w=>w.id===y.id))}#k(y,w){return"none"===this.tooltipsSetting?null:"nameOnly"===this.tooltipsSetting?w:"full"===this.tooltipsSetting&&y?y.includes("tah-tooltip-wrapper")?y:`<div class="tah-tooltip-wrapper">${y}</div>`:w}#T(y){const w=y.fullName??y.name,A=this.#k(y?.tooltip,w);return{encodedValue:y.encodedValue,id:y.id,name:y.name,fullName:w,listName:y.listName??y.name,cssClass:y.cssClass??"",icons:y.icon??{},icon1:y.icon1??"",icon2:y.icon2??"",icon3:y.icon3??"",img:y.img??"",info1:{class:y?.info1?.class??"",text:y?.info1?.text??"",title:y?.info1?.title??""},info2:{class:y?.info2?.class??"",text:y?.info2?.text??"",title:y?.info2?.title??""},info3:{class:y?.info3?.class??"",text:y?.info3?.text??"",title:y?.info3?.title??""},isAction:!0,isItem:y.isitem??null,isPreset:y.isPreset??!1,userSelected:y.userSelected??!0,systemSelected:y.systemSelected??!0,selected:!!y.systemSelected&&(y.userSelected??y.systemSelected??!0),tooltip:A,useRawHtmlName:y.useRawHtmlName??!1}}async updateActions(y,w){const A=this.#w(w),k=A.actions,H=[];for(const w of y){if(w.id.includes("itemMacro"))continue;const y=A.actions.find((y=>y.id===w.id));if(y){const w={...y,userSelected:!0};H.push(w)}else{const y=this.availableActions.find((y=>y.id===w.id));if(y){const w={...y,userSelected:!0};H.push(w)}}}for(const w of k){if(!w.id||w?.id.includes("itemMacro"))continue;if(!y.find((y=>y.id===w.id))&&w.isPreset){const y={...w,userSelected:!1};H.push(y)}}w.settings.sort&&H.sort(((y,w)=>y.name.localeCompare(w.name))),A.actions=H}#I(y){for(const w of y){this.availableActions.find((y=>y.id===w.id))||this.availableActions.push(w)}}async#m(){this.availableActions.sort(((y,w)=>y.listName.localeCompare(w.listName)))}async getAvailableActions(){return this.availableActions.map((y=>this.#x(y)))}async getSelectedActions(y){const w=this.#w(y);if(w)return w.actions.filter((y=>!0===y.selected)).map((y=>this.#x(y)))}async getSelectedGroups(y={}){y.selected=!0,y.level=(y.level||0)+1;const w=this.#A(y);return w?.map((y=>this.#E(y)))??[]}async getAvailableGroups(y){return[...await this.#M(y),...await this.#O(),...await this.#L(),...await this.#U()]}async#L(){return game.packs.filter((y=>C.includes(y.documentName)&&(game.version.startsWith("11")?y.visible:!y.private||game.user.isGM))).map((y=>({id:y.metadata.id.replace(".","-"),listName:`Group: ${y.metadata.label}`,name:y.metadata.label,type:"core"}))).map((y=>this.#E(y)))}async#M(y){const w=this.#A({nestId:y?.nestId,type:x.SYSTEM_DERIVED});return w?.map((y=>this.#E(y)))??[]}async#U(){return[this.#E({id:"macros",listName:`Group: ${Utils.i18n("tokenActionHud.macros")}`,name:Utils.i18n("tokenActionHud.macros"),type:"core"})]}async#O(){return Object.values(this.defaultGroups).map((y=>this.#E(y)))}async addGroup(y,w,A=!1){if(y.type=y?.type??"system-derived",y.style=y?.style??"list",!w?.id&&!w?.nestId)return;const k=this.#A(w);if(k?.length)for(const w of k){const k=`${w.nestId}_${y.id}`,H=this.#A({...y,nestId:k});if(H.length)if(A)for(const w of H)y.info&&(Object.assign(y,{...y.info}),delete y.info),Object.assign(w,this.#v({...w,...y},!0));else for(const w of H){const A=this.#k(y.tooltip,w.name);Object.assign(w,{tooltip:A})}else{const A=this.#v({...y,nestId:k});"tab"===A.settings.style?w.groups.tabs.push(A):w.groups.lists.push(A),this.groups[A.nestId]=A}}}async updateGroup(y,w=null){y.type=y?.type??"system-derived";const updateExistingGroups=w=>{for(const A of w)y.info&&(Object.assign(y,{...y.info}),delete y.info),Object.assign(A,this.#v({...A,...y},!0))};if(w){const A=this.#A(w);for(const w of A){const A=`${w.nestId}_${y.id}`;updateExistingGroups(this.#A({...y,nestId:A}))}}else{updateExistingGroups(this.#A(y))}}removeGroup(y){!y?.nestId&&y?.id&&Utils.deleteGroupsById(this.hud.groups,y.id);const w=this.#A(y);if(w?.length)for(const A of w)delete this.groups[A.nestId],y?.nestId&&Utils.deleteGroupByNestId(this.hud.groups,A.nestId)}async addGroupInfo(y){const w=y?.id,A=y?.info;if(!w||!A)return;this.#A(y).forEach((y=>{y.info1=A.info1,y.info2=A.info2,y.info3=A.info3}))}async addActions(y,w){if(!y.length)return;const A=y.map((y=>this.#T(y)));if(this.#I(A),!w?.id)return;const k=this.#A(w);if(k)for(const y of k){const w=y.actions??[],k=[];for(const y of w){const w=A.find((w=>w.id===y.id));if(w){const A=w.systemSelected??y.systemSelected,k=y.userSelected??w.userSelected,H=!!A&&(k??A??!0);Object.assign(y,{...w,isPreset:!0,selected:H,systemSelected:A,userSelected:k})}else if(!y.selected&&y.isPreset){const w=!1;Object.assign(y,this.#T({...y,systemSelected:w}))}}for(const y of A){w.find((w=>w.id===y.id))||k.push(this.#T({...y,isPreset:!0}))}y.settings.sort&&k.sort(((y,w)=>y.name.localeCompare(w.name))),y.actions.push(...k)}}async#f(){const y=this.#A({level:1});for(const w of y){const y=w?.settings?.characterCount,A=this.#A({nestId:w.nestId});for(const w of A){const A=w.actions;if(!A||0===A?.length)continue;const k=w?.settings?.characterCount,H=k>=0?y:k;if(!(!H&&0!==H||H<0))for(const y of A)y.name.length<=H||(y.name=0!==H?y.name.split(" ").map((y=>y.slice(0,H))).join(" "):"")}}}addFurtherActionHandler(y){Logger.debug("Adding further action handler...",{handler:y}),this.furtherActionHandlers.push(y)}isLinkedCompendium(y){return!!this.#w({id:y})}#E(y){return{id:y.id,name:y.name,type:y.type,value:y.listName??y.name}}#x(y){return{id:y.id,name:y.name,type:"action",value:y.listName??y.name}}async addActionsToActionList(y,w){globalThis.logger.warn("Token Action HUD | ActionHandler.addActionsToActionList is deprecated. Use ActionHandler.addActions"),await this.addActions(y,w)}async addSubcategoryInfo(y){globalThis.logger.warn("Token Action HUD | ActionHandler.addSubcategoryInfo is deprecated. Use ActionHandler.addGroupInfo"),this.addGroupInfo(y)}async addSubcategoryToActionList(y,w,A=!1){globalThis.logger.warn("Token Action HUD | ActionHandler.addSubcategoryToActionList is deprecated. Use ActionHandler.addGroup"),this.addGroup(w,y,A)}sortItems(y){return globalThis.logger.warn("ActionHandler.sortItems is deprecated. Use Utils.sortItems"),Utils.sortItems(y)}sortItemsByName(y){return globalThis.logger.warn("ActionHandler.sortItemsByName is deprecated. Use Utils.sortItemsByName"),Utils.sortItemsByName(y)}}class ActionListExtender extends ActionHandler{extendActionList(){}}class MigrationManager{constructor(y){this.socket=y}async init(){if(!game.user.isGM)return;const y=game.modules.get("token-action-hud-core").version,w=Utils.getSetting("migrationVersion");if(y===w)return;let A=!0;A=!(!w||w<"1.4.10")||await this.#N(),A=!(DataHandler.isPersistentStorage()&&(!w||w<"1.4.11"))||await this.#G(),A&&Utils.setSetting("migrationVersion",y)}async#N(){try{const w=game.users.filter((w=>w.getFlag(y.ID,"categories")));for(const A of w)A.unsetFlag(y.ID,"categories"),A.unsetFlag(y.ID,"defaults");const A=game.actors.filter((w=>w.getFlag(y.ID,"categories")));for(const w of A)w.unsetFlag(y.ID,"categories");const k=game.canvas.tokens.objects.children.filter((w=>w.actor?.getFlag(y.ID,"categories")));for(const w of k)w.actor?.unsetFlag(y.ID,"categories");for(const w of game.scenes){const A=w.tokens.filter((w=>w.actor?.getFlag(y.ID,"categories")));for(const w of A)w.actor?.unsetFlag(y.ID,"categories")}return!0}catch(y){return Logger.debug(y.message,y),!1}}async#G(){try{Logger.info("Migrating files to persistent storage...",!0);for(const y of game.users){const w=await DataHandler.getDataMigrate("user",y.id);w&&await DataHandler.saveData("user",y.id,w)}for(const y of game.actors){const w=await DataHandler.getDataMigrate("actor",y.id);w&&await DataHandler.saveData("actor",y.id,w)}return Logger.info("Successfully migrated files to persistent storage",!0),!0}catch{return Logger.info("Failed to migrate files to persistent storage",!0),!1}}}class RollHandler{actor=null;token=null;delimiter=k;preRollHandlers=[];throwInvalidValueErr(y){throw new Error(`Error handling button click: ${y}`)}async handleActionEvent(y,w,A){Logger.debug(`Handling event for action [${w}]`,{event:y}),this.actor=A.actor,this.token=A.token,this.registerKeyPresses(y);let k=!1;this.preRollHandlers.forEach((H=>{k||(k=H.prehandleActionEvent(y,w,A))})),k||(this._isGenericAction(w)?await this._handleGenericAction(w):this.doHandleActionEvent(y,w))}doHandleActionEvent(y,w){}addPreRollHandler(y){Logger.debug(`Adding pre-roll handler ${y.constructor.name}`),this.preRollHandlers.push(y)}registerKeyPresses(y){this.rightClick=this.isRightClick(y),this.ctrl=this.isCtrl(y),this.alt=this.isAlt(y),this.shift=this.isShift(y)}doRenderItem(y,w){y||(y=this.actor);Utils.getItem(y,w).sheet.render(!0)}isRenderItem(){return Utils.getSetting("renderItemOnRightClick")&&this.rightClick&&!(this.alt||this.ctrl||this.shift)}isRightClick(y){return 2===y?.originalEvent?.button}isAlt(y){const w=game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT);return y.altKey&&!w?(Logger.debug("Emulating LEFT ALT key press"),KeyboardManager.emulateKeypress(!1,"AltLeft",{altKey:!0,force:!0}),game.keyboard.downKeys.add("AltLeft"),!0):w}isCtrl(y){const w=game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL);return y.ctrlKey&&!w?(Logger.debug("Emulating LEFT CTRL key press"),KeyboardManager.emulateKeypress(!1,"ControlLeft",{ctrlKey:!0,force:!0}),game.keyboard.downKeys.add("ControlLeft"),!0):w}isShift(y){const w=game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT);return y.shiftKey&&!w?(Logger.debug("Emulating LEFT SHIFT key press"),KeyboardManager.emulateKeypress(!1,"ShiftLeft",{shiftKey:!0,force:!0}),game.keyboard.downKeys.add("ShiftLeft"),!0):w}_isGenericAction(y){const w=y.split(k),A=w[0],H=w[1];return"utility"===A&&H.includes("toggle")}async _handleGenericAction(y){const w=y.split(k)[1],A=Utils.getFirstControlledToken();"toggleVisibility"===w&&await A.toggleVisibility(),"toggleCombat"===w&&await A.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHud")}}class PreRollHandler extends RollHandler{prehandleActionEvent(y,w){return!1}}class CustomStyleForm extends FormApplication{static get defaultOptions(){return mergeObject(super.defaultOptions,{title:Utils.i18n("tokenActionHud.settings.customStyle.form.title"),template:A.customStyleForm,id:"token-action-hud-core-settings",width:600,height:600,popOut:!0,resizable:!0,closeOnSubmit:!0})}constructor(...y){super(y)}getData(){return this.data={backgroundColor:Utils.getSetting("backgroundColor",I.backgroundColor.default),buttonHeight:Utils.getSetting("buttonHeight",I.buttonHeight.default),buttonBackgroundColor:Utils.getSetting("buttonBackgroundColor",I.buttonBackgroundColor.default),buttonHoverBackgroundColor:Utils.getSetting("buttonHoverBackgroundColor",I.buttonHoverBackgroundColor.default),buttonToggleActiveBackgroundColor:Utils.getSetting("buttonToggleActiveBackgroundColor",I.buttonToggleActiveBackgroundColor.default),buttonToggleHoverBackgroundColor:Utils.getSetting("buttonToggleHoverBackgroundColor",I.buttonToggleHoverBackgroundColor.default),buttonTextColor:Utils.getSetting("buttonTextColor",I.buttonTextColor.default),buttonHoverTextColor:Utils.getSetting("buttonHoverTextColor",I.buttonHoverTextColor.default),buttonToggleActiveTextColor:Utils.getSetting("buttonToggleActiveTextColor",I.buttonToggleActiveTextColor.default),buttonToggleHoverTextColor:Utils.getSetting("buttonToggleHoverTextColor",I.buttonToggleHoverTextColor.default),buttonBorderPrimaryColor:Utils.getSetting("buttonBorderPrimaryColor",I.buttonBorderPrimaryColor.default),buttonBorderSecondaryColor:Utils.getSetting("buttonBorderSecondaryColor",I.buttonBorderSecondaryColor.default),buttonHoverBorderPrimaryColor:Utils.getSetting("buttonHoverBorderPrimaryColor",I.buttonHoverBorderPrimaryColor.default),buttonHoverBorderSecondaryColor:Utils.getSetting("buttonHoverBorderSecondaryColor",I.buttonHoverBorderSecondaryColor.default),buttonToggleActiveBorderPrimaryColor:Utils.getSetting("buttonToggleActiveBorderPrimaryColor",I.buttonToggleActiveBorderPrimaryColor.default),buttonToggleActiveBorderSecondaryColor:Utils.getSetting("buttonToggleActiveBorderSecondaryColor",I.buttonToggleActiveBorderSecondaryColor.default),buttonToggleHoverBorderPrimaryColor:Utils.getSetting("buttonToggleHoverBorderPrimaryColor",I.buttonToggleHoverBorderPrimaryColor.default),buttonToggleHoverBorderSecondaryColor:Utils.getSetting("buttonToggleHoverBorderSecondaryColor",I.buttonToggleHoverBorderSecondaryColor.default),textPrimaryColor:Utils.getSetting("textPrimaryColor",I.textPrimaryColor.default),textSecondaryColor:Utils.getSetting("textSecondaryColor",I.textSecondaryColor.default),textTertiaryColor:Utils.getSetting("textTertiaryColor",I.textTertiaryColor.default),textHoverPrimaryColor:Utils.getSetting("textHoverPrimaryColor",I.textHoverPrimaryColor.default),textHoverSecondaryColor:Utils.getSetting("textHoverSecondaryColor",I.textHoverSecondaryColor.default),textHoverTertiaryColor:Utils.getSetting("textHoverTertiaryColor",I.textHoverTertiaryColor.default)},this.data}activateListeners(y){super.activateListeners(y);y.find("#tah-custom-style-reset-button").on("click",this._reset.bind(this)),"undefined"!=typeof ColorPicker&&ColorPicker.install()}_reset(){for(const[y,w]of Object.entries(I))Utils.setSetting(y,w.default),document.querySelector(":root").style.setProperty(w.cssProperty,w.default);this.render(!0)}_updateObject(y,w){for(const[y,A]of Object.entries(w)){const w=I[y];A!==this.data[y]&&(Utils.setSetting(y,A),document.querySelector(":root").style.setProperty(w.cssProperty,A))}}}class TahSettingsForm extends FormApplication{static get defaultOptions(){return mergeObject(super.defaultOptions,{template:A.settings,id:"token-action-hud-core-settings",width:600,height:"auto",closeOnSubmit:!0})}constructor(...y){super(y)}async getData(){const y=[];for(const[w,A]of Object.entries(this.settings)){if("world"===A?.scope&&!game.user.isGM)continue;const k=w,H=Utils.i18n(A.hint),S=A.icon,C=Utils.i18n(A.label),D=Utils.i18n(A.name),I=A?.scope?await Utils.getSetting(w):"",x=A.type instanceof Function?A.type.name:"String",E="button"===A.inputType,M=A.onClick,O="checkbox"===A.inputType,L="filePicker"===A.inputType,U="filePicker"===A.inputType?x??"any":"",G="number"===A.inputType,P="range"===A.inputType&&A.range,_=void 0!==A.choices;y.push({id:k,hint:H,icon:S,label:C,name:D,value:I,type:x,isButton:E,onClick:M,isCheckbox:O,isFilePicker:L,filePickerType:U,isNumber:G,isRange:P,isSelect:_})}return{settings:y}}activateListeners(y){super.activateListeners(y),super.activateListeners(y);y.find("#tah-form-cancel").on("click",this.close.bind(this))}_updateObject(y,w){for(const[y,A]of Object.entries(w))this.settings[y].scope&&(Utils.setSetting(y,A),game.tokenActionHud.updateSettings(y,A));game.tokenActionHud.update()}}class TahSettingsFormLayout extends TahSettingsForm{constructor(){super(),this.settings=M}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:Utils.i18n("tokenActionHud.settings.layout.form.title")})}}function onChangeFunction(y,w){game.tokenActionHud&&game.tokenActionHud.updateSettings(y,w)}Hooks.on("init",(async()=>{game.keybindings.register(y.ID,"toggleHud",{name:Utils.i18n("tokenActionHud.toggleHud"),editable:[],onDown:()=>{game.tokenActionHud.toggleHud()}})}));const registerSettings=function(w,A){game.settings.registerMenu(y.ID,"customStyle",{hint:Utils.i18n("tokenActionHud.settings.customStyle.hint"),label:Utils.i18n("tokenActionHud.settings.customStyle.label"),name:Utils.i18n("tokenActionHud.settings.customStyle.name"),icon:"fas fa-palette",type:CustomStyleForm,restricted:!1,scope:"client"}),game.settings.registerMenu(y.ID,"layout",{hint:Utils.i18n("tokenActionHud.settings.layout.hint"),label:Utils.i18n("tokenActionHud.settings.layout.label"),name:Utils.i18n("tokenActionHud.settings.layout.name"),icon:"fas fa-table-layout",type:TahSettingsFormLayout,restricted:!1,scope:"client"}),game.settings.register(y.ID,"startup",{name:"One-Time Startup Prompt",scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(y.ID,"migrationVersion",{name:"Migration Version",scope:"world",config:!1,type:String,default:"0.0"}),game.settings.register(y.ID,"style",{name:Utils.i18n("tokenActionHud.settings.style.name"),hint:Utils.i18n("tokenActionHud.settings.style.hint"),scope:"client",config:!0,type:String,default:"foundryVTT",choices:{foundryVTT:"Foundry VTT Dark",foundryVttLight:"Foundry VTT Light",compact:"Foundry VTT Compact Dark",dorakoUI:"Dorako UI",highContrast:"High Contrast",pathfinder:"Pathfinder",custom:"Custom"},onChange:y=>{Utils.switchCSS(y)}}),game.settings.register(y.ID,"customLayout",{name:Utils.i18n("tokenActionHud.settings.customLayout.name"),hint:Utils.i18n("tokenActionHud.settings.customLayout.hint"),scope:"world",config:!1,type:String}),game.settings.register(y.ID,"direction",{name:Utils.i18n("tokenActionHud.settings.direction.name"),hint:Utils.i18n("tokenActionHud.settings.direction.hint"),scope:"client",config:!0,type:String,default:"auto",choices:{auto:Utils.i18n("tokenActionHud.settings.direction.choice.auto"),up:Utils.i18n("tokenActionHud.settings.direction.choice.up"),down:Utils.i18n("tokenActionHud.settings.direction.choice.down")},onChange:y=>{onChangeFunction("direction",y)}}),game.settings.register(y.ID,"grid",{name:Utils.i18n("tokenActionHud.settings.grid.name"),hint:Utils.i18n("tokenActionHud.settings.grid.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:y=>{onChangeFunction("grid",y)}}),game.settings.register(y.ID,"scale",{name:Utils.i18n("tokenActionHud.settings.scale.name"),hint:Utils.i18n("tokenActionHud.settings.scale.hint"),scope:"client",config:!0,type:Number,range:{min:.5,max:2,step:.05},default:1,onChange:y=>{onChangeFunction("scale",y)}}),game.settings.register(y.ID,"drag",{name:Utils.i18n("tokenActionHud.settings.drag.name"),hint:Utils.i18n("tokenActionHud.settings.drag.hint"),scope:"client",config:!0,type:String,default:"whenUnlocked",choices:{always:Utils.i18n("tokenActionHud.settings.drag.choices.always"),whenUnlocked:Utils.i18n("tokenActionHud.settings.drag.choices.whenUnlocked"),never:Utils.i18n("tokenActionHud.settings.drag.choices.never")},onChange:y=>{onChangeFunction("drag",y)}}),game.settings.register(y.ID,"enable",{name:Utils.i18n("tokenActionHud.settings.enable.name"),hint:Utils.i18n("tokenActionHud.settings.enable.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:y=>{onChangeFunction("enable",y)}}),game.settings.register(y.ID,"rollHandler",{name:Utils.i18n("tokenActionHud.settings.rollHandler.name"),hint:Utils.i18n("tokenActionHud.settings.rollHandler.hint"),scope:"world",config:!0,type:String,choices:A,default:"core",onChange:y=>{onChangeFunction("rollHandler",y)}}),game.settings.register(y.ID,"allow",{name:Utils.i18n("tokenActionHud.settings.allow.name"),hint:Utils.i18n("tokenActionHud.settings.allow.hint"),scope:"world",config:!0,type:String,choices:{4:Utils.i18n("tokenActionHud.settings.allow.choice.4"),3:Utils.i18n("tokenActionHud.settings.allow.choice.3"),2:Utils.i18n("tokenActionHud.settings.allow.choice.2"),1:Utils.i18n("tokenActionHud.settings.allow.choice.1")},default:1,requiresReload:!0}),game.settings.register(y.ID,"enableCustomization",{name:Utils.i18n("tokenActionHud.settings.enableCustomization.name"),hint:Utils.i18n("tokenActionHud.settings.enableCustomization.hint"),scope:"world",config:!0,type:Boolean,default:!0,onChange:y=>{onChangeFunction("enableCustomization",y)}}),game.settings.register(y.ID,"alwaysShowHud",{name:Utils.i18n("tokenActionHud.settings.alwaysShowHud.name"),hint:Utils.i18n("tokenActionHud.settings.alwaysShowHud.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:y=>{onChangeFunction("alwaysShowHud",y)}}),game.settings.register(y.ID,"displayCharacterName",{name:Utils.i18n("tokenActionHud.settings.displayCharacterName.name"),hint:Utils.i18n("tokenActionHud.settings.displayCharacterName.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:y=>{onChangeFunction("displayCharacterName",y)}}),game.settings.register(y.ID,"displayIcons",{name:Utils.i18n("tokenActionHud.settings.displayIcons.name"),hint:Utils.i18n("tokenActionHud.settings.displayIcons.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:y=>{onChangeFunction("displayIcons",y)}}),game.settings.register(y.ID,"tooltips",{name:Utils.i18n("tokenActionHud.settings.tooltips.name"),hint:Utils.i18n("tokenActionHud.settings.tooltips.hint"),scope:"client",config:!0,type:String,default:"full",choices:{full:Utils.i18n("tokenActionHud.settings.tooltips.choices.full"),nameOnly:Utils.i18n("tokenActionHud.settings.tooltips.choices.nameOnly"),none:Utils.i18n("tokenActionHud.settings.tooltips.choices.none")},onChange:y=>{onChangeFunction("tooltips",y)}}),game.settings.register(y.ID,"clickOpenCategory",{name:Utils.i18n("tokenActionHud.settings.clickOpenCategory.name"),hint:Utils.i18n("tokenActionHud.settings.clickOpenCategory.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:y=>{onChangeFunction("clickOpenCategory",y)}}),game.settings.register(y.ID,"renderItemOnRightClick",{name:Utils.i18n("tokenActionHud.settings.renderItemOnRightClick.name"),hint:Utils.i18n("tokenActionHud.settings.renderItemOnRightClick.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:y=>{onChangeFunction("renderItemOnRightClick",y)}}),Utils.isModuleActive("itemacro")&&!Utils.isModuleActive("midi-qol")&&game.settings.register(y.ID,"itemMacro",{name:Utils.i18n("tokenActionHud.settings.itemMacro.name"),hint:Utils.i18n("tokenActionHud.settings.itemMacro.hint"),scope:"client",config:!0,type:String,choices:{both:Utils.i18n("tokenActionHud.settings.itemMacro.choices.both"),itemMacro:Utils.i18n("tokenActionHud.settings.itemMacro.choices.itemMacro"),original:Utils.i18n("tokenActionHud.settings.itemMacro.choices.original")},default:"both",onChange:y=>{onChangeFunction("itemMacro",y)}}),game.settings.register(y.ID,"activeCssAsText",{name:Utils.i18n("tokenActionHud.settings.activeCssAsText.name"),hint:Utils.i18n("tokenActionHud.settings.activeCssAsText.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:y=>{onChangeFunction("activeCssAsText",y)}}),game.settings.register(y.ID,"debug",{name:Utils.i18n("tokenActionHud.settings.debug.name"),hint:Utils.i18n("tokenActionHud.settings.debug.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:y=>{onChangeFunction("debug",y)}}),function registerCustomStyleSettings(){for(const[w,A]of Object.entries(I))game.settings.register(y.ID,w,{scope:"client",config:!1,type:A.type,default:A.default})}(),w.doRegisterSettings(onChangeFunction),Logger.debug("Available roll handlers",{rollHandlers:A})};class ItemMacroActionListExtender extends ActionListExtender{constructor(y){super(y),this.actionHandler=y,this.actor=this.actionHandler.actor,this.token=this.actionHandler.token}extendActionList(){if(this.actor=this.actionHandler.actor,this.token=this.actionHandler.token,!this.actor)return;const y=this.actor.items.filter((y=>y.flags?.itemacro?.macro?.command));let w;if(w=Utils.isModuleActive("midi-qol")?y.filter(this.#P).map((y=>y.id)):y.map((y=>y.id)),!w)return;if(0===w.length)return;const A=Utils.getSetting("itemMacro");if("original"===A)return;const k="itemMacro"===A;Object.keys(this.actionHandler.groups).forEach((y=>{const A=this.actionHandler.groups[y];this.#_(w,A,k)}))}#_(y,w,A){if(!w?.actions?.length)return;const k=[];w.actions.forEach((H=>{if(!y.includes(H.id))return;const S=w.actions.find((y=>y.id===`itemMacro+${H.id}`)),C=S??H;S&&(A=!0);const D=this.#F(H,C,A);A||k.push(D)})),this.#B(k,w)}#F(y,w,A){const H=A?w:Utils.deepClone(y);return H.encodedValue=`itemMacro${y.encodedValue?.substr(y.encodedValue.indexOf(k))}`,H.id=`itemMacro+${y.id}`,H.fullName=y.fullName,H.listName=`Item Macro: ${y.fullName}`,H.name=y.name,H.itemMacroIcon=`<i class="${E.ICON}" data-tooltip="${E.TOOLTIP}"></i>`,H}#B(y,w){y.forEach((y=>{const A=w.actions.findIndex((w=>w.id===y.id))+1;w.actions.splice(A,0,y)}))}#P(y){return!y.getFlag("midi-qol","onUseMacroName")}}class CompendiumMacroPreHandler extends PreRollHandler{prehandleActionEvent(y,w){const A=w.split(k);if(A.length<2)return!1;let H=null,C=null,D=null;if(2===A.length&&(H=A[0],D=A[1]),3===A.length&&(H=A[0],C=A[1],D=A[2]),!S.includes(H))return!1;switch(H){case"compendiumEntry":this._handleCompendium(C,D);break;case"compendiumMacro":this._handleMacroCompendium(C,D);break;case"compendiumPlaylist":this._handlePlaylistCompendium(C,D);break;case"macro":this._handleMacro(D);break;default:return!1}return!0}_handleCompendium(y,w){game.packs.get(y).getDocument(w).then((y=>y.sheet.render(!0)))}_handleMacroCompendium(y,w){game.packs.get(y).getDocument(w).then((y=>y.execute()))}async _handlePlaylistCompendium(y,w){const A=game.packs.get(y),k=w.split(">"),H=k[0],S=k[1],C=(await A.getDocument(H)).sounds.find((y=>y._id===S));AudioHelper.play({src:C.path},{})}_handleMacro(y){game.macros.find((w=>w.id===y)).execute()}}class ItemMacroPreRollHandler extends PreRollHandler{prehandleActionEvent(y,w,A){this.actor=A.actor;const H=w.split(k);if(2!==H.length)return!1;const S=H[0],C=H[1];return"itemMacro"===S&&(this.isRenderItem()?(this.doRenderItem(this.actor,C),!0):this.#$(C))}#$(y){const w=Utils.getItem(this.actor,y);try{w.executeMacro()}catch(y){return Logger.debug("ItemMacro Error",y),!1}return!0}}class SystemManager{constructor(){this.coreModuleId=y.ID}doGetActionHandler(){}doGetRollHandler(y){}getAvailableRollHandlers(){}doRegisterSettings(y){}async doRegisterDefaultFlags(){}async registerDefaultFlags(){await Utils.unsetUserFlag("default");const y=await this.doRegisterDefaultFlags()??[];y&&(y?.categories&&globalThis.logger.warn("Token Action HUD | SystemManager.doRegisterDefaultFlags expects 'layout' to be returned instead of 'categories'"),y?.subcategories&&globalThis.logger.warn("Token Action HUD | SystemManager.doRegisterDefaultFlags expects 'groups' to be returned instead of 'subcategories'"),game.tokenActionHud.defaults=y)}async getActionHandler(){const y=this.doGetActionHandler();return this.addActionExtenders(y),y}addActionExtenders(y){Utils.isModuleActive("itemacro")&&!Utils.isModuleActive("midi-qol")&&y.addFurtherActionHandler(new ItemMacroActionListExtender(y))}getRollHandler(){let y=Utils.getSetting("rollHandler");"core"===y||Utils.isModuleActive(y)||(Logger.error(y,Utils.i18n("tokenActionHud.handlerNotFound")),y="core",Utils.setSetting("rollHandler",y));const w=this.doGetRollHandler(y);return this.addPreHandlers(w),w}addPreHandlers(y){y.addPreRollHandler(new CompendiumMacroPreHandler),Utils.isModuleActive("itemacro")&&!Utils.isModuleActive("midi-qol")&&y.addPreRollHandler(new ItemMacroPreRollHandler)}registerSettings(){const y=this.getAvailableRollHandlers();registerSettings(this,y)}static addHandler(y,w){if(Utils.isModuleActive(w)){const A=Utils.getModuleTitle(w);mergeObject(y,{[w]:A})}}}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function getDefaultExportFromCjs(y){return y&&y.__esModule&&Object.prototype.hasOwnProperty.call(y,"default")?y.default:y}var L={exports:{}};!function(y,w){var A,k;A=function(){var y,w=0,A={},k={},H=(y=window.MutationObserver||window.WebKitMutationObserver,function(w,A){w&&1===w.nodeType&&(y?new y((function(y,w){A(y)})).observe(w,{childList:!0,subtree:!1}):window.addEventListener&&w.addEventListener("DOMNodeInserted",A,!1))});function a(y,w){if(!y)return this;w=w||{},this.parentElm=y,this.uid=w.uid,this.settings={selector:"*",callbacks:{}},Object.assign(this.settings,w),this.setup(),H(this.parentElm,this.setup.bind(this)),this.bindEvents()}return a.prototype={namespace:"dragsort",setup(){[...this.parentElm.childNodes].forEach((y=>{if(1!=y.nodeType)return y.parentNode.removeChild(y);y.matches(this.settings.selector)&&(y.draggable=!0)})),this.gap=this.getItemsGap(this.parentElm.firstElementChild)},throttle(y,w){var A=!1,k=this;return function(H){A||(y.call(k,H),A=!0,setTimeout((()=>A=!1),w))}},getDraggableElm(y){if(!y.closest)return null;var w=y.closest('[draggable="true"]');return this.uid==A.uid?w:null},dragstart(y,w){A=this;var k,H=this.getDraggableElm(w);H?(this.source=this.getInitialState(),this.target=this.getInitialState(),k=H.getBoundingClientRect(),this.source.elm=H,this.source.idx=this.getNodeIndex(H),this.source.size.width=k.width,this.source.size.height=k.height,y.dataTransfer.effectAllowed="move",this.settings.callbacks.dragStart&&this.settings.callbacks.dragStart(this.source.elm,y),setTimeout(this.afterDragStart.bind(this))):A={}},afterDragStart(){var y="vertical"==this.settings.mode?"height":"width";this.parentElm.classList.add(`${this.namespace}--dragStart`),this.source.elm.style[y]=this.source.size[y]+"px",this.source.elm.classList.add(`${this.namespace}--dragElem`)},dragover(y){y.preventDefault(),y.stopPropagation();var w=y.target;if((w=this.getDraggableElm(w))&&this.target){var A=this.target.elm,k=this.target.hoverDirection;y.dataTransfer.dropEffect="move",this.target.hoverDirection=this.getTargetDirection(y),A==w&&k==this.target.hoverDirection||this.directionAwareDragEnter(y,w)}},dragenter(y,w){(w=this.getDraggableElm(w))&&this.target&&this.isValidElm(w)&&this.source.elm!=w&&this.source.elm&&(this.target.bounding=w.getBoundingClientRect())},directionAwareDragEnter(y,w){var A;y.preventDefault(),y.stopPropagation(),y.dataTransfer.dropEffect="none",this.isValidElm(w)&&this.source.elm!=w&&this.source.elm&&(y.dataTransfer.dropEffect="move",this.cleanupLastTarget(),this.target.elm=w,this.target.idx=this.getNodeIndex(w),w.classList.add("over"),A=Math.abs(this.target.idx-this.source.idx),this.source.elm.classList.toggle(`${this.namespace}--hide`,A>0),"vertical"==this.settings.mode?this.target.elm.style[this.target.hoverDirection?"marginBottom":"marginTop"]=this.source.size.height+this.gap+"px":this.target.elm.style[this.target.hoverDirection?"marginRight":"marginLeft"]=this.source.size.width+this.gap+"px")},dragend(y){if(clearTimeout(this.dragoverTimeout),this.dragoverTimeout=null,this.parentElm.classList.remove(`${this.namespace}--dragStart`),!this.isValidElm(this.target.elm))return this.cleanup();var w=this.target.hoverDirection?this.target.elm.nextElementSibling:this.target.elm;return this.source.elm!=this.target.elm&&this.target.elm&&(this.target.elm.classList.add(`${this.namespace}--noAnim`),this.cleanup(),this.parentElm.insertBefore(this.source.elm,w)),this.source.elm&&this.source.elm.classList.remove(`${this.namespace}--dragElem`,`${this.namespace}--hide`),this.settings.callbacks.dragEnd&&this.settings.callbacks.dragEnd(this.source.elm),this},isTargetLastChild(){return this.parentElm.lastElementChild==this.target.elm},getTargetDirection(y){if(this.target.bounding)return"vertical"==this.settings.mode?y.pageY>this.target.bounding.top+this.target.bounding.height/2?1:0:y.pageX>this.target.bounding.left+this.target.bounding.width/2?1:0},getNodeIndex(y){for(var w=0;y=y.previousSibling;)3==y.nodeType&&/^\s*$/.test(y.data)||w++;return w},isValidElm(y){return y&&y.nodeType&&y.parentNode==this.parentElm},cleanup(){A={},[...this.parentElm.children].forEach((y=>{y.removeAttribute("style"),setTimeout((()=>{y.classList.remove(`${this.namespace}--over`,`${this.namespace}--noAnim`,`${this.namespace}--dragElem`)}),50)}))},cleanupLastTarget(){this.target.elm&&(this.target.elm.classList.remove(`${this.namespace}--hide`,`${this.namespace}--over`),this.target.elm.removeAttribute("style"))},getInitialState:()=>({elm:null,size:{}}),getItemsGap(y){var w=getComputedStyle(y),A=getComputedStyle(y.parentNode),k="vertical"==this.settings.mode,H=parseInt(A.gap)||0;return parseInt(w["margin"+(k?"Top":"Left")])+parseInt(w["margin"+(k?"Bottom":"Right")])+H},bindEvents(y){for(var w in this.listeners=this.listeners||{dragstart:y=>this.dragstart(y,y.target),dragenter:y=>this.dragenter(y,y.target),dragend:y=>this.dragend(y,y.target),dragover:this.throttle(this.dragover,350)},this.listeners)this.parentElm[y?"removeEventListener":"addEventListener"](w,this.listeners[w])},destroy(){this.cleanup(),this.bindEvents(!0),delete k[this.uid]}},function(y,A){return k[++w]=y.DragSort?k[y.DragSort]:new a(y,{...A,uid:w}),y.DragSort=w,k[w]}},"function"==typeof(k=k||{})&&k.amd?k([],A):y.exports=A()}(L);var U=getDefaultExportFromCjs(L.exports),G={exports:{}},P=getDefaultExportFromCjs(G.exports=function(){function t(y,w){var A=Object.keys(y);if(Object.getOwnPropertySymbols){var k=Object.getOwnPropertySymbols(y);w&&(k=k.filter((function(w){return Object.getOwnPropertyDescriptor(y,w).enumerable}))),A.push.apply(A,k)}return A}function e(y){for(var w=1;w<arguments.length;w++){var A=null!=arguments[w]?arguments[w]:{};w%2?t(Object(A),!0).forEach((function(w){i(y,w,A[w])})):Object.getOwnPropertyDescriptors?Object.defineProperties(y,Object.getOwnPropertyDescriptors(A)):t(Object(A)).forEach((function(w){Object.defineProperty(y,w,Object.getOwnPropertyDescriptor(A,w))}))}return y}function i(y,w,A){return(w=function(y){var w=function(y,w){if("object"!=typeof y||null===y)return y;var A=y[Symbol.toPrimitive];if(void 0!==A){var k=A.call(y,w||"default");if("object"!=typeof k)return k;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===w?String:Number)(y)}(y,"string");return"symbol"==typeof w?w:String(w)}(w))in y?Object.defineProperty(y,w,{value:A,enumerable:!0,configurable:!0,writable:!0}):y[w]=A,y}const s=(y,w,A,k)=>(y=""+y,w=""+w,k&&(y=y.trim(),w=w.trim()),A?y==w:y.toLowerCase()==w.toLowerCase()),a=(y,w)=>y&&Array.isArray(y)&&y.map((y=>n(y,w)));function n(y,w){var A,k={};for(A in y)w.indexOf(A)<0&&(k[A]=y[A]);return k}function o(y){var w=document.createElement("div");return y.replace(/\&#?[0-9a-z]+;/gi,(function(y){return w.innerHTML=y,w.innerText}))}function r(y){return(new DOMParser).parseFromString(y.trim(),"text/html").body.firstElementChild}function l(y,w){for(w=w||"previous";y=y[w+"Sibling"];)if(3==y.nodeType)return y}function d(y){return"string"==typeof y?y.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/`|'/g,"&#039;"):y}function h(y){var w=Object.prototype.toString.call(y).split(" ")[1].slice(0,-1);return y===Object(y)&&"Array"!=w&&"Function"!=w&&"RegExp"!=w&&"HTMLUnknownElement"!=w}function g(y,w,A){function s(y,w){for(var A in w)if(w.hasOwnProperty(A)){if(h(w[A])){h(y[A])?s(y[A],w[A]):y[A]=Object.assign({},w[A]);continue}if(Array.isArray(w[A])){y[A]=Object.assign([],w[A]);continue}y[A]=w[A]}}return y instanceof Object||(y={}),s(y,w),A&&s(y,A),y}function p(){const y=[],w={};for(let A of arguments)for(let k of A)h(k)?w[k.value]||(y.push(k),w[k.value]=1):y.includes(k)||y.push(k);return y}function c(y){return String.prototype.normalize?"string"==typeof y?y.normalize("NFD").replace(/[\u0300-\u036f]/g,""):void 0:y}var u=()=>/(?=.*chrome)(?=.*android)/i.test(navigator.userAgent);function m(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(y=>(y^crypto.getRandomValues(new Uint8Array(1))[0]&15>>y/4).toString(16)))}function v(y){return y&&y.classList&&y.classList.contains(this.settings.classNames.tag)}function f(y,w){var A=window.getSelection();return w=w||A.getRangeAt(0),"string"==typeof y&&(y=document.createTextNode(y)),w&&(w.deleteContents(),w.insertNode(y)),y}function T(y,w,A){return y?(w&&(y.__tagifyTagData=A?w:g({},y.__tagifyTagData||{},w)),y.__tagifyTagData):(console.warn("tag element doesn't exist",y,w),w)}var y={delimiters:",",pattern:null,tagTextProp:"value",maxTags:1/0,callbacks:{},addTagOnBlur:!0,onChangeAfterBlur:!0,duplicates:!1,whitelist:[],blacklist:[],enforceWhitelist:!1,userInput:!0,keepInvalidTags:!1,createInvalidTags:!0,mixTagsAllowedAfter:/,|\.|\:|\s/,mixTagsInterpolator:["[[","]]"],backspace:!0,skipInvalid:!1,pasteAsTags:!0,editTags:{clicks:2,keepInvalid:!0},transformTag:()=>{},trim:!0,a11y:{focusableTags:!1},mixMode:{insertAfterTag:" "},autoComplete:{enabled:!0,rightKey:!1},classNames:{namespace:"tagify",mixMode:"tagify--mix",selectMode:"tagify--select",input:"tagify__input",focus:"tagify--focus",tagNoAnimation:"tagify--noAnim",tagInvalid:"tagify--invalid",tagNotAllowed:"tagify--notAllowed",scopeLoading:"tagify--loading",hasMaxTags:"tagify--hasMaxTags",hasNoTags:"tagify--noTags",empty:"tagify--empty",inputInvalid:"tagify__input--invalid",dropdown:"tagify__dropdown",dropdownWrapper:"tagify__dropdown__wrapper",dropdownHeader:"tagify__dropdown__header",dropdownFooter:"tagify__dropdown__footer",dropdownItem:"tagify__dropdown__item",dropdownItemActive:"tagify__dropdown__item--active",dropdownItemHidden:"tagify__dropdown__item--hidden",dropdownInital:"tagify__dropdown--initial",tag:"tagify__tag",tagText:"tagify__tag-text",tagX:"tagify__tag__removeBtn",tagLoading:"tagify__tag--loading",tagEditing:"tagify__tag--editable",tagFlash:"tagify__tag--flash",tagHide:"tagify__tag--hide"},dropdown:{classname:"",enabled:2,maxItems:10,searchKeys:["value","searchBy"],fuzzySearch:!0,caseSensitive:!1,accentedSearch:!0,includeSelectedTags:!1,highlightFirst:!1,closeOnSelect:!0,clearOnSelect:!0,position:"all",appendTarget:null},hooks:{beforeRemoveTag:()=>Promise.resolve(),beforePaste:()=>Promise.resolve(),suggestionClick:()=>Promise.resolve()}};function b(){this.dropdown={};for(let y in this._dropdown)this.dropdown[y]="function"==typeof this._dropdown[y]?this._dropdown[y].bind(this):this._dropdown[y];this.dropdown.refs()}var w={refs(){this.DOM.dropdown=this.parseTemplate("dropdown",[this.settings]),this.DOM.dropdown.content=this.DOM.dropdown.querySelector("[data-selector='tagify-suggestions-wrapper']")},getHeaderRef(){return this.DOM.dropdown.querySelector("[data-selector='tagify-suggestions-header']")},getFooterRef(){return this.DOM.dropdown.querySelector("[data-selector='tagify-suggestions-footer']")},getAllSuggestionsRefs(){return[...this.DOM.dropdown.content.querySelectorAll(this.settings.classNames.dropdownItemSelector)]},show(y){var w,A,k,H=this.settings,S="mix"==H.mode&&!H.enforceWhitelist,C=!H.whitelist||!H.whitelist.length,D="manual"==H.dropdown.position;if(y=void 0===y?this.state.inputText:y,!(C&&!S&&!H.templates.dropdownItemNoMatch||!1===H.dropdown.enable||this.state.isLoading||this.settings.readonly)){if(clearTimeout(this.dropdownHide__bindEventsTimeout),this.suggestedListItems=this.dropdown.filterListItems(y),y&&!this.suggestedListItems.length&&(this.trigger("dropdown:noMatch",y),H.templates.dropdownItemNoMatch&&(k=H.templates.dropdownItemNoMatch.call(this,{value:y}))),!k){if(this.suggestedListItems.length)y&&S&&!this.state.editing.scope&&!s(this.suggestedListItems[0].value,y)&&this.suggestedListItems.unshift({value:y});else{if(!y||!S||this.state.editing.scope)return this.input.autocomplete.suggest.call(this),void this.dropdown.hide();this.suggestedListItems=[{value:y}]}A=""+(h(w=this.suggestedListItems[0])?w.value:w),H.autoComplete&&A&&0==A.indexOf(y)&&this.input.autocomplete.suggest.call(this,w)}this.dropdown.fill(k),H.dropdown.highlightFirst&&this.dropdown.highlightOption(this.DOM.dropdown.content.querySelector(H.classNames.dropdownItemSelector)),this.state.dropdown.visible||setTimeout(this.dropdown.events.binding.bind(this)),this.state.dropdown.visible=y||!0,this.state.dropdown.query=y,this.setStateSelection(),D||setTimeout((()=>{this.dropdown.position(),this.dropdown.render()})),setTimeout((()=>{this.trigger("dropdown:show",this.DOM.dropdown)}))}},hide(y){var w=this.DOM,A=w.scope,k=w.dropdown,H="manual"==this.settings.dropdown.position&&!y;if(k&&document.body.contains(k)&&!H)return window.removeEventListener("resize",this.dropdown.position),this.dropdown.events.binding.call(this,!1),A.setAttribute("aria-expanded",!1),k.parentNode.removeChild(k),setTimeout((()=>{this.state.dropdown.visible=!1}),100),this.state.dropdown.query=this.state.ddItemData=this.state.ddItemElm=this.state.selection=null,this.state.tag&&this.state.tag.value.length&&(this.state.flaggedTags[this.state.tag.baseOffset]=this.state.tag),this.trigger("dropdown:hide",k),this},toggle(y){this.dropdown[this.state.dropdown.visible&&!y?"hide":"show"]()},render(){var y,w,A=((w=this.DOM.dropdown.cloneNode(!0)).style.cssText="position:fixed; top:-9999px; opacity:0",document.body.appendChild(w),y=w.clientHeight,w.parentNode.removeChild(w),y),k=this.settings;return"number"==typeof k.dropdown.enabled&&k.dropdown.enabled>=0?(this.DOM.scope.setAttribute("aria-expanded",!0),document.body.contains(this.DOM.dropdown)||(this.DOM.dropdown.classList.add(k.classNames.dropdownInital),this.dropdown.position(A),k.dropdown.appendTarget.appendChild(this.DOM.dropdown),setTimeout((()=>this.DOM.dropdown.classList.remove(k.classNames.dropdownInital)))),this):this},fill(y){y="string"==typeof y?y:this.dropdown.createListHTML(y||this.suggestedListItems);var w,A=this.settings.templates.dropdownContent.call(this,y);this.DOM.dropdown.content.innerHTML=(w=A)?w.replace(/\>[\r\n ]+\</g,"><").replace(/(<.*?>)|\s+/g,((y,w)=>w||" ")):""},fillHeaderFooter(){var y=this.dropdown.filterListItems(this.state.dropdown.query),w=this.parseTemplate("dropdownHeader",[y]),A=this.parseTemplate("dropdownFooter",[y]),k=this.dropdown.getHeaderRef(),H=this.dropdown.getFooterRef();w&&k?.parentNode.replaceChild(w,k),A&&H?.parentNode.replaceChild(A,H)},refilter(y){y=y||this.state.dropdown.query||"",this.suggestedListItems=this.dropdown.filterListItems(y),this.dropdown.fill(),this.suggestedListItems.length||this.dropdown.hide(),this.trigger("dropdown:updated",this.DOM.dropdown)},position(y){var w=this.settings.dropdown;if("manual"!=w.position){var A,k,H,S,C,D,I=this.DOM.dropdown,x=w.placeAbove,E=w.appendTarget===document.body,M=E?window.pageYOffset:w.appendTarget.scrollTop,O=document.fullscreenElement||document.webkitFullscreenElement||document.documentElement,L=O.clientHeight,U=Math.max(O.clientWidth||0,window.innerWidth||0)>480?w.position:"all",G=this.DOM["input"==U?"input":"scope"];if(y=y||I.clientHeight,this.state.dropdown.visible){if("text"==U?(H=(A=function(){const y=document.getSelection();if(y.rangeCount){const w=y.getRangeAt(0),A=w.startContainer,k=w.startOffset;let H,S;if(k>0)return S=document.createRange(),S.setStart(A,k-1),S.setEnd(A,k),H=S.getBoundingClientRect(),{left:H.right,top:H.top,bottom:H.bottom};if(A.getBoundingClientRect)return A.getBoundingClientRect()}return{left:-9999,top:-9999}}()).bottom,k=A.top,S=A.left,C="auto"):(D=function(y){for(var w=0,A=0;y&&y!=O;)w+=y.offsetLeft||0,A+=y.offsetTop||0,y=y.parentNode;return{left:w,top:A}}(w.appendTarget),k=(A=G.getBoundingClientRect()).top-D.top,H=A.bottom-1-D.top,S=A.left-D.left,C=A.width+"px"),!E){let y=function(){for(var y=0,A=w.appendTarget.parentNode;A;)y+=A.scrollTop||0,A=A.parentNode;return y}();k+=y,H+=y}k=Math.floor(k),H=Math.ceil(H),x=void 0===x?L-A.bottom<y:x,I.style.cssText="left:"+(S+window.pageXOffset)+"px; width:"+C+";"+(x?"top: "+(k+M)+"px":"top: "+(H+M)+"px"),I.setAttribute("placement",x?"top":"bottom"),I.setAttribute("position",U)}}},events:{binding(){let y=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];var w=this.dropdown.events.callbacks,A=this.listeners.dropdown=this.listeners.dropdown||{position:this.dropdown.position.bind(this,null),onKeyDown:w.onKeyDown.bind(this),onMouseOver:w.onMouseOver.bind(this),onMouseLeave:w.onMouseLeave.bind(this),onClick:w.onClick.bind(this),onScroll:w.onScroll.bind(this)},k=y?"addEventListener":"removeEventListener";"manual"!=this.settings.dropdown.position&&(document[k]("scroll",A.position,!0),window[k]("resize",A.position),window[k]("keydown",A.onKeyDown)),this.DOM.dropdown[k]("mouseover",A.onMouseOver),this.DOM.dropdown[k]("mouseleave",A.onMouseLeave),this.DOM.dropdown[k]("mousedown",A.onClick),this.DOM.dropdown.content[k]("scroll",A.onScroll)},callbacks:{onKeyDown(y){if(this.state.hasFocus&&!this.state.composing){var w=this.DOM.dropdown.querySelector(this.settings.classNames.dropdownItemActiveSelector),A=this.dropdown.getSuggestionDataByNode(w);switch(y.key){case"ArrowDown":case"ArrowUp":case"Down":case"Up":y.preventDefault();var k=this.dropdown.getAllSuggestionsRefs(),H="ArrowUp"==y.key||"Up"==y.key;w&&(w=this.dropdown.getNextOrPrevOption(w,!H)),w&&w.matches(this.settings.classNames.dropdownItemSelector)||(w=k[H?k.length-1:0]),this.dropdown.highlightOption(w,!0);break;case"Escape":case"Esc":this.dropdown.hide();break;case"ArrowRight":if(this.state.actions.ArrowLeft)return;case"Tab":if("mix"!=this.settings.mode&&w&&!this.settings.autoComplete.rightKey&&!this.state.editing){y.preventDefault();var S=this.dropdown.getMappedValue(A);return this.input.autocomplete.set.call(this,S),!1}return!0;case"Enter":y.preventDefault(),this.settings.hooks.suggestionClick(y,{tagify:this,tagData:A,suggestionElm:w}).then((()=>{if(w)return this.dropdown.selectOption(w),w=this.dropdown.getNextOrPrevOption(w,!H),void this.dropdown.highlightOption(w);this.dropdown.hide(),"mix"!=this.settings.mode&&this.addTags(this.state.inputText.trim(),!0)})).catch((y=>y));break;case"Backspace":{if("mix"==this.settings.mode||this.state.editing.scope)return;const y=this.input.raw.call(this);""!=y&&8203!=y.charCodeAt(0)||(!0===this.settings.backspace?this.removeTags():"edit"==this.settings.backspace&&setTimeout(this.editTag.bind(this),0))}}}},onMouseOver(y){var w=y.target.closest(this.settings.classNames.dropdownItemSelector);w&&this.dropdown.highlightOption(w)},onMouseLeave(y){this.dropdown.highlightOption()},onClick(y){if(0==y.button&&y.target!=this.DOM.dropdown&&y.target!=this.DOM.dropdown.content){var w=y.target.closest(this.settings.classNames.dropdownItemSelector),A=this.dropdown.getSuggestionDataByNode(w);this.state.actions.selectOption=!0,setTimeout((()=>this.state.actions.selectOption=!1),50),this.settings.hooks.suggestionClick(y,{tagify:this,tagData:A,suggestionElm:w}).then((()=>{w?this.dropdown.selectOption(w,y):this.dropdown.hide()})).catch((y=>console.warn(y)))}},onScroll(y){var w=y.target,A=w.scrollTop/(w.scrollHeight-w.parentNode.clientHeight)*100;this.trigger("dropdown:scroll",{percentage:Math.round(A)})}}},getSuggestionDataByNode(y){var w=y&&y.getAttribute("value");return this.suggestedListItems.find((y=>y.value==w))||null},getNextOrPrevOption(y){let w=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];var A=this.dropdown.getAllSuggestionsRefs(),k=A.findIndex((w=>w===y));return w?A[k+1]:A[k-1]},highlightOption(y,w){var A,k=this.settings.classNames.dropdownItemActive;if(this.state.ddItemElm&&(this.state.ddItemElm.classList.remove(k),this.state.ddItemElm.removeAttribute("aria-selected")),!y)return this.state.ddItemData=null,this.state.ddItemElm=null,void this.input.autocomplete.suggest.call(this);A=this.dropdown.getSuggestionDataByNode(y),this.state.ddItemData=A,this.state.ddItemElm=y,y.classList.add(k),y.setAttribute("aria-selected",!0),w&&(y.parentNode.scrollTop=y.clientHeight+y.offsetTop-y.parentNode.clientHeight),this.settings.autoComplete&&(this.input.autocomplete.suggest.call(this,A),this.dropdown.position())},selectOption(y,w){var A=this.settings.dropdown,k=A.clearOnSelect,H=A.closeOnSelect;if(!y)return this.addTags(this.state.inputText,!0),void(H&&this.dropdown.hide());w=w||{};var S=y.getAttribute("value"),C="noMatch"==S,D=this.suggestedListItems.find((y=>(y.value??y)==S));this.trigger("dropdown:select",{data:D,elm:y,event:w}),S&&(D||C)?(this.state.editing?this.onEditTagDone(null,g({__isValid:!0},this.normalizeTags([D])[0])):this["mix"==this.settings.mode?"addMixTags":"addTags"]([D||this.input.raw.call(this)],k),this.DOM.input.parentNode&&(setTimeout((()=>{this.DOM.input.focus(),this.toggleFocusClass(!0)})),H&&setTimeout(this.dropdown.hide.bind(this)),y.addEventListener("transitionend",(()=>{this.dropdown.fillHeaderFooter(),setTimeout((()=>y.remove()),100)}),{once:!0}),y.classList.add(this.settings.classNames.dropdownItemHidden))):H&&setTimeout(this.dropdown.hide.bind(this))},selectAll(y){this.suggestedListItems.length=0,this.dropdown.hide(),this.dropdown.filterListItems("");var w=this.dropdown.filterListItems("");return y||(w=this.state.dropdown.suggestions),this.addTags(w,!0),this},filterListItems(y,w){var A,k,H,S,C,D=this.settings,I=D.dropdown,x=(w=w||{},[]),E=[],M=D.whitelist,O=I.maxItems>=0?I.maxItems:1/0,L=I.searchKeys,U=0;if(!(y="select"==D.mode&&this.value.length&&this.value[0][D.tagTextProp]==y?"":y)||!L.length)return x=I.includeSelectedTags?M:M.filter((y=>!this.isTagDuplicate(h(y)?y.value:y))),this.state.dropdown.suggestions=x,x.slice(0,O);function f(y,w){return w.toLowerCase().split(" ").every((w=>y.includes(w.toLowerCase())))}for(C=I.caseSensitive?""+y:(""+y).toLowerCase();U<M.length;U++){let y,D;A=M[U]instanceof Object?M[U]:{value:M[U]};let O=Object.keys(A).some((y=>L.includes(y)))?L:["value"];I.fuzzySearch&&!w.exact?(H=O.reduce(((y,w)=>y+" "+(A[w]||"")),"").toLowerCase().trim(),I.accentedSearch&&(H=c(H),C=c(C)),y=0==H.indexOf(C),D=H===C,k=f(H,C)):(y=!0,k=O.some((y=>{var k=""+(A[y]||"");return I.accentedSearch&&(k=c(k),C=c(C)),I.caseSensitive||(k=k.toLowerCase()),D=k===C,w.exact?k===C:0==k.indexOf(C)}))),S=!I.includeSelectedTags&&this.isTagDuplicate(h(A)?A.value:A),k&&!S&&(D&&y?E.push(A):"startsWith"==I.sortby&&y?x.unshift(A):x.push(A))}return this.state.dropdown.suggestions=E.concat(x),"function"==typeof I.sortby?I.sortby(E.concat(x),C):E.concat(x).slice(0,O)},getMappedValue(y){var w=this.settings.dropdown.mapValueTo;return w?"function"==typeof w?w(y):y[w]||y.value:y.value},createListHTML(y){return g([],y).map(((y,w)=>{"string"!=typeof y&&"number"!=typeof y||(y={value:y});var A=this.dropdown.getMappedValue(y);return A="string"==typeof A?d(A):A,this.settings.templates.dropdownItem.apply(this,[e(e({},y),{},{mappedValue:A}),this])})).join("")}};const A="@yaireo/tagify/";var k,H={empty:"empty",exceed:"number of tags exceeded",pattern:"pattern mismatch",duplicate:"already exists",notAllowed:"not allowed"},S={wrapper:(y,w)=>`<tags class="${w.classNames.namespace} ${w.mode?`${w.classNames[w.mode+"Mode"]}`:""} ${y.className}"\n                    ${w.readonly?"readonly":""}\n                    ${w.disabled?"disabled":""}\n                    ${w.required?"required":""}\n                    ${"select"===w.mode?"spellcheck='false'":""}\n                    tabIndex="-1">\n            <span ${!w.readonly&&w.userInput?"contenteditable":""} tabIndex="0" data-placeholder="${w.placeholder||"&#8203;"}" aria-placeholder="${w.placeholder||""}"\n                class="${w.classNames.input}"\n                role="textbox"\n                aria-autocomplete="both"\n                aria-multiline="${"mix"==w.mode}"></span>\n                &#8203;\n        </tags>`,tag(y,w){let A=w.settings;return`<tag title="${y.title||y.value}"\n                    contenteditable='false'\n                    spellcheck='false'\n                    tabIndex="${A.a11y.focusableTags?0:-1}"\n                    class="${A.classNames.tag} ${y.class||""}"\n                    ${this.getAttributes(y)}>\n            <x title='' class="${A.classNames.tagX}" role='button' aria-label='remove tag'></x>\n            <div>\n                <span class="${A.classNames.tagText}">${y[A.tagTextProp]||y.value}</span>\n            </div>\n        </tag>`},dropdown(y){var w=y.dropdown,A="manual"==w.position,k=`${y.classNames.dropdown}`;return`<div class="${A?"":k} ${w.classname}" role="listbox" aria-labelledby="dropdown">\n                    <div data-selector='tagify-suggestions-wrapper' class="${y.classNames.dropdownWrapper}"></div>\n                </div>`},dropdownContent(y){var w=this.settings,A=this.state.dropdown.suggestions;return`\n            ${w.templates.dropdownHeader.call(this,A)}\n            ${y}\n            ${w.templates.dropdownFooter.call(this,A)}\n        `},dropdownItem(y){return`<div ${this.getAttributes(y)}\n                    class='${this.settings.classNames.dropdownItem} ${y.class?y.class:""}'\n                    tabindex="0"\n                    role="option">${y.mappedValue||y.value}</div>`},dropdownHeader(y){return`<header data-selector='tagify-suggestions-header' class="${this.settings.classNames.dropdownHeader}"></header>`},dropdownFooter(y){var w=y.length-this.settings.dropdown.maxItems;return w>0?`<footer data-selector='tagify-suggestions-footer' class="${this.settings.classNames.dropdownFooter}">\n                ${w} more items. Refine your search.\n            </footer>`:""},dropdownItemNoMatch:null},C={customBinding(){this.customEventsList.forEach((y=>{this.on(y,this.settings.callbacks[y])}))},binding(){let y=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];var w,A=this.events.callbacks,k=y?"addEventListener":"removeEventListener";if(!this.state.mainEvents||!y){for(var H in this.state.mainEvents=y,y&&!this.listeners.main&&(this.events.bindGlobal.call(this),this.settings.isJQueryPlugin&&jQuery(this.DOM.originalInput).on("tagify.removeAllTags",this.removeAllTags.bind(this))),w=this.listeners.main=this.listeners.main||{focus:["input",A.onFocusBlur.bind(this)],keydown:["input",A.onKeydown.bind(this)],click:["scope",A.onClickScope.bind(this)],dblclick:["scope",A.onDoubleClickScope.bind(this)],paste:["input",A.onPaste.bind(this)],drop:["input",A.onDrop.bind(this)],compositionstart:["input",A.onCompositionStart.bind(this)],compositionend:["input",A.onCompositionEnd.bind(this)]})this.DOM[w[H][0]][k](H,w[H][1]);clearInterval(this.listeners.main.originalInputValueObserverInterval),this.listeners.main.originalInputValueObserverInterval=setInterval(A.observeOriginalInputValue.bind(this),500);var S=this.listeners.main.inputMutationObserver||new MutationObserver(A.onInputDOMChange.bind(this));S.disconnect(),"mix"==this.settings.mode&&S.observe(this.DOM.input,{childList:!0})}},bindGlobal(y){var w,A=this.events.callbacks,k=y?"removeEventListener":"addEventListener";if(this.listeners&&(y||!this.listeners.global))for(w of(this.listeners.global=this.listeners.global||[{type:this.isIE?"keydown":"input",target:this.DOM.input,cb:A[this.isIE?"onInputIE":"onInput"].bind(this)},{type:"keydown",target:window,cb:A.onWindowKeyDown.bind(this)},{type:"blur",target:this.DOM.input,cb:A.onFocusBlur.bind(this)},{type:"click",target:document,cb:A.onClickAnywhere.bind(this)}],this.listeners.global))w.target[k](w.type,w.cb)},unbindGlobal(){this.events.bindGlobal.call(this,!0)},callbacks:{onFocusBlur(y){var w=this.settings,A=y.target?this.trim(y.target.textContent):"",k=this.value?.[0]?.[w.tagTextProp],H=y.type,S=w.dropdown.enabled>=0,C={relatedTarget:y.relatedTarget},D=this.state.actions.selectOption&&(S||!w.dropdown.closeOnSelect),I=this.state.actions.addNew&&S,x=y.relatedTarget&&v.call(this,y.relatedTarget)&&this.DOM.scope.contains(y.relatedTarget);if("blur"==H){if(y.relatedTarget===this.DOM.scope)return this.dropdown.hide(),void this.DOM.input.focus();this.postUpdate(),w.onChangeAfterBlur&&this.triggerChangeEvent()}if(!D&&!I)if(this.state.hasFocus="focus"==H&&+new Date,this.toggleFocusClass(this.state.hasFocus),"mix"!=w.mode){if("focus"==H)return this.trigger("focus",C),void(0!==w.dropdown.enabled&&w.userInput||this.dropdown.show(this.value.length?"":void 0));"blur"==H&&(this.trigger("blur",C),this.loading(!1),"select"==w.mode&&(x&&(this.removeTags(),A=""),k===A&&(A="")),A&&!this.state.actions.selectOption&&w.addTagOnBlur&&this.addTags(A,!0)),this.DOM.input.removeAttribute("style"),this.dropdown.hide()}else"focus"==H?this.trigger("focus",C):"blur"==y.type&&(this.trigger("blur",C),this.loading(!1),this.dropdown.hide(),this.state.dropdown.visible=void 0,this.setStateSelection())},onCompositionStart(y){this.state.composing=!0},onCompositionEnd(y){this.state.composing=!1},onWindowKeyDown(y){var w,A=document.activeElement,k=v.call(this,A)&&this.DOM.scope.contains(document.activeElement),H=k&&A.hasAttribute("readonly");if(k&&!H)switch(w=A.nextElementSibling,y.key){case"Backspace":this.settings.readonly||(this.removeTags(A),(w||this.DOM.input).focus());break;case"Enter":setTimeout(this.editTag.bind(this),0,A)}},onKeydown(y){var w=this.settings;if(!this.state.composing&&w.userInput){"select"==w.mode&&w.enforceWhitelist&&this.value.length&&"Tab"!=y.key&&y.preventDefault();var A=this.trim(y.target.textContent);if(this.trigger("keydown",{event:y}),"mix"==w.mode){switch(y.key){case"Left":case"ArrowLeft":this.state.actions.ArrowLeft=!0;break;case"Delete":case"Backspace":if(this.state.editing)return;var H=document.getSelection(),S="Delete"==y.key&&H.anchorOffset==(H.anchorNode.length||0),C=H.anchorNode.previousSibling,D=1==H.anchorNode.nodeType||!H.anchorOffset&&C&&1==C.nodeType&&H.anchorNode.previousSibling;o(this.DOM.input.innerHTML);var I,x,E,M=this.getTagElms();if("edit"==w.backspace&&D)return I=1==H.anchorNode.nodeType?null:H.anchorNode.previousElementSibling,setTimeout(this.editTag.bind(this),0,I),void y.preventDefault();if(u()&&D instanceof Element)return E=l(D),D.hasAttribute("readonly")||D.remove(),this.DOM.input.focus(),void setTimeout((()=>{this.placeCaretAfterNode(E),this.DOM.input.click()}));if("BR"==H.anchorNode.nodeName)return;if((S||D)&&1==H.anchorNode.nodeType?x=0==H.anchorOffset?S?M[0]:null:M[Math.min(M.length,H.anchorOffset)-1]:S?x=H.anchorNode.nextElementSibling:D instanceof Element&&(x=D),3==H.anchorNode.nodeType&&!H.anchorNode.nodeValue&&H.anchorNode.previousElementSibling&&y.preventDefault(),(D||S)&&!w.backspace)return void y.preventDefault();if("Range"!=H.type&&!H.anchorOffset&&H.anchorNode==this.DOM.input&&"Delete"!=y.key)return void y.preventDefault();if("Range"!=H.type&&x&&x.hasAttribute("readonly"))return void this.placeCaretAfterNode(l(x));clearTimeout(k),k=setTimeout((()=>{var y=document.getSelection();o(this.DOM.input.innerHTML),!S&&y.anchorNode.previousSibling,this.value=[].map.call(M,((y,w)=>{var A=T(y);if(y.parentNode||A.readonly)return A;this.trigger("remove",{tag:y,index:w,data:A})})).filter((y=>y))}),20)}return!0}switch(y.key){case"Backspace":"select"==w.mode&&w.enforceWhitelist&&this.value.length?this.removeTags():this.state.dropdown.visible&&"manual"!=w.dropdown.position||""!=y.target.textContent&&8203!=A.charCodeAt(0)||(!0===w.backspace?this.removeTags():"edit"==w.backspace&&setTimeout(this.editTag.bind(this),0));break;case"Esc":case"Escape":if(this.state.dropdown.visible)return;y.target.blur();break;case"Down":case"ArrowDown":this.state.dropdown.visible||this.dropdown.show();break;case"ArrowRight":{let y=this.state.inputSuggestion||this.state.ddItemData;if(y&&w.autoComplete.rightKey)return void this.addTags([y],!0);break}case"Tab":{let k="select"==w.mode;if(!A||k)return!0;y.preventDefault()}case"Enter":if(this.state.dropdown.visible&&"manual"!=w.dropdown.position)return;y.preventDefault(),setTimeout((()=>{this.state.dropdown.visible||this.state.actions.selectOption||this.addTags(A,!0)}))}}},onInput(y){this.postUpdate();var w=this.settings;if("mix"==w.mode)return this.events.callbacks.onMixTagsInput.call(this,y);var A=this.input.normalize.call(this),k=A.length>=w.dropdown.enabled,H={value:A,inputElm:this.DOM.input},S=this.validateTag({value:A});"select"==w.mode&&this.toggleScopeValidation(S),H.isValid=S,this.state.inputText!=A&&(this.input.set.call(this,A,!1),-1!=A.search(w.delimiters)?this.addTags(A)&&this.input.set.call(this):w.dropdown.enabled>=0&&this.dropdown[k?"show":"hide"](A),this.trigger("input",H))},onMixTagsInput(y){var w,A,k,H,S,C,D,I,x=this.settings,E=this.value.length,M=this.getTagElms(),O=document.createDocumentFragment(),L=window.getSelection().getRangeAt(0),U=[].map.call(M,(y=>T(y).value));if("deleteContentBackward"==y.inputType&&u()&&this.events.callbacks.onKeydown.call(this,{target:y.target,key:"Backspace"}),this.value.slice().forEach((y=>{y.readonly&&!U.includes(y.value)&&O.appendChild(this.createTagElem(y))})),O.childNodes.length&&(L.insertNode(O),this.setRangeAtStartEnd(!1,O.lastChild)),M.length!=E)return this.value=[].map.call(this.getTagElms(),(y=>T(y))),void this.update({withoutChangeEvent:!0});if(this.hasMaxTags())return!0;if(window.getSelection&&(C=window.getSelection()).rangeCount>0&&3==C.anchorNode.nodeType){if((L=C.getRangeAt(0).cloneRange()).collapse(!0),L.setStart(C.focusNode,0),k=(w=L.toString().slice(0,L.endOffset)).split(x.pattern).length-1,(A=w.match(x.pattern))&&(H=w.slice(w.lastIndexOf(A[A.length-1]))),H){if(this.state.actions.ArrowLeft=!1,this.state.tag={prefix:H.match(x.pattern)[0],value:H.replace(x.pattern,"")},this.state.tag.baseOffset=C.baseOffset-this.state.tag.value.length,I=this.state.tag.value.match(x.delimiters))return this.state.tag.value=this.state.tag.value.replace(x.delimiters,""),this.state.tag.delimiters=I[0],this.addTags(this.state.tag.value,x.dropdown.clearOnSelect),void this.dropdown.hide();S=this.state.tag.value.length>=x.dropdown.enabled;try{D=(D=this.state.flaggedTags[this.state.tag.baseOffset]).prefix==this.state.tag.prefix&&D.value[0]==this.state.tag.value[0],this.state.flaggedTags[this.state.tag.baseOffset]&&!this.state.tag.value&&delete this.state.flaggedTags[this.state.tag.baseOffset]}catch(y){}(D||k<this.state.mixMode.matchedPatternCount)&&(S=!1)}else this.state.flaggedTags={};this.state.mixMode.matchedPatternCount=k}setTimeout((()=>{this.update({withoutChangeEvent:!0}),this.trigger("input",g({},this.state.tag,{textContent:this.DOM.input.textContent})),this.state.tag&&this.dropdown[S?"show":"hide"](this.state.tag.value)}),10)},onInputIE(y){var w=this;setTimeout((function(){w.events.callbacks.onInput.call(w,y)}))},observeOriginalInputValue(){this.DOM.originalInput.parentNode||this.destroy(),this.DOM.originalInput.value!=this.DOM.originalInput.tagifyValue&&this.loadOriginalValues()},onClickAnywhere(y){y.target==this.DOM.scope||this.DOM.scope.contains(y.target)||(this.toggleFocusClass(!1),this.state.hasFocus=!1)},onClickScope(y){var w=this.settings,A=y.target.closest("."+w.classNames.tag),k=+new Date-this.state.hasFocus;if(y.target!=this.DOM.scope){if(!y.target.classList.contains(w.classNames.tagX))return A?(this.trigger("click",{tag:A,index:this.getNodeIndex(A),data:T(A),event:y}),void(1!==w.editTags&&1!==w.editTags.clicks||this.events.callbacks.onDoubleClickScope.call(this,y))):void(y.target==this.DOM.input&&("mix"==w.mode&&this.fixFirefoxLastTagNoCaret(),k>500)?this.state.dropdown.visible?this.dropdown.hide():0===w.dropdown.enabled&&"mix"!=w.mode&&this.dropdown.show(this.value.length?"":void 0):"select"!=w.mode||0!==w.dropdown.enabled||this.state.dropdown.visible||this.dropdown.show());this.removeTags(y.target.parentNode)}else this.DOM.input.focus()},onPaste(y){y.preventDefault();var w,A,k=this.settings;if("select"==k.mode&&k.enforceWhitelist||!k.userInput)return!1;k.readonly||(w=y.clipboardData||window.clipboardData,A=w.getData("Text"),k.hooks.beforePaste(y,{tagify:this,pastedText:A,clipboardData:w}).then((w=>{void 0===w&&(w=A),w&&(this.injectAtCaret(w,window.getSelection().getRangeAt(0)),"mix"==this.settings.mode?this.events.callbacks.onMixTagsInput.call(this,y):this.settings.pasteAsTags?this.addTags(this.state.inputText+w,!0):this.state.inputText=w)})).catch((y=>y)))},onDrop(y){y.preventDefault()},onEditTagInput(y,w){var A=y.closest("."+this.settings.classNames.tag),k=this.getNodeIndex(A),H=T(A),S=this.input.normalize.call(this,y),C={[this.settings.tagTextProp]:S,__tagId:H.__tagId},D=this.validateTag(C);this.editTagChangeDetected(g(H,C))||!0!==y.originalIsValid||(D=!0),A.classList.toggle(this.settings.classNames.tagInvalid,!0!==D),H.__isValid=D,A.title=!0===D?H.title||H.value:D,S.length>=this.settings.dropdown.enabled&&(this.state.editing&&(this.state.editing.value=S),this.dropdown.show(S)),this.trigger("edit:input",{tag:A,index:k,data:g({},this.value[k],{newValue:S}),event:w})},onEditTagPaste(y,w){var A=(w.clipboardData||window.clipboardData).getData("Text");w.preventDefault();var k=f(A);this.setRangeAtStartEnd(!1,k)},onEditTagFocus(y){this.state.editing={scope:y,input:y.querySelector("[contenteditable]")}},onEditTagBlur(y){if(this.state.hasFocus||this.toggleFocusClass(),this.DOM.scope.contains(y)){var w,A,k=this.settings,H=y.closest("."+k.classNames.tag),S=T(H),C=this.input.normalize.call(this,y),D={[k.tagTextProp]:C,__tagId:S.__tagId},I=S.__originalData,x=this.editTagChangeDetected(g(S,D)),E=this.validateTag(D);if(C)if(x){if(w=this.hasMaxTags(),A=g({},I,{[k.tagTextProp]:this.trim(C),__isValid:E}),k.transformTag.call(this,A,I),!0!==(E=(!w||!0===I.__isValid)&&this.validateTag(A))){if(this.trigger("invalid",{data:A,tag:H,message:E}),k.editTags.keepInvalid)return;k.keepInvalidTags?A.__isValid=E:A=I}else k.keepInvalidTags&&(delete A.title,delete A["aria-invalid"],delete A.class);this.onEditTagDone(H,A)}else this.onEditTagDone(H,I);else this.onEditTagDone(H)}},onEditTagkeydown(y,w){if(!this.state.composing)switch(this.trigger("edit:keydown",{event:y}),y.key){case"Esc":case"Escape":w.parentNode.replaceChild(w.__tagifyTagData.__originalHTML,w),this.state.editing=!1;case"Enter":case"Tab":y.preventDefault(),y.target.blur()}},onDoubleClickScope(y){var w,A,k=y.target.closest("."+this.settings.classNames.tag),H=T(k),S=this.settings;k&&S.userInput&&!1!==H.editable&&(w=k.classList.contains(this.settings.classNames.tagEditing),A=k.hasAttribute("readonly"),"select"==S.mode||S.readonly||w||A||!this.settings.editTags||this.editTag(k),this.toggleFocusClass(!0),this.trigger("dblclick",{tag:k,index:this.getNodeIndex(k),data:T(k)}))},onInputDOMChange(y){y.forEach((y=>{y.addedNodes.forEach((y=>{if("<div><br></div>"==y.outerHTML)y.replaceWith(document.createElement("br"));else if(1==y.nodeType&&y.querySelector(this.settings.classNames.tagSelector)){let w=document.createTextNode("");3==y.childNodes[0].nodeType&&"BR"!=y.previousSibling.nodeName&&(w=document.createTextNode("\n")),y.replaceWith(w,...[...y.childNodes].slice(0,-1)),this.placeCaretAfterNode(w)}else if(v.call(this,y)&&(3!=y.previousSibling?.nodeType||y.previousSibling.textContent||y.previousSibling.remove(),y.previousSibling&&"BR"==y.previousSibling.nodeName)){y.previousSibling.replaceWith("\n​");let w=y.nextSibling,A="";for(;w;)A+=w.textContent,w=w.nextSibling;A.trim()&&this.placeCaretAfterNode(y.previousSibling)}})),y.removedNodes.forEach((y=>{y&&"BR"==y.nodeName&&v.call(this,w)&&(this.removeTags(w),this.fixFirefoxLastTagNoCaret())}))}));var w=this.DOM.input.lastChild;w&&""==w.nodeValue&&w.remove(),w&&"BR"==w.nodeName||this.DOM.input.appendChild(document.createElement("br"))}}};function N(y,w){if(!y){console.warn("Tagify:","input element not found",y);const w=new Proxy(this,{get:()=>()=>w});return w}if(y.__tagify)return console.warn("Tagify: ","input element is already Tagified - Same instance is returned.",y),y.__tagify;var k;g(this,function(y){var w=document.createTextNode("");function i(y,A,k){k&&A.split(/\s+/g).forEach((A=>w[y+"EventListener"].call(w,A,k)))}return{off(y,w){return i("remove",y,w),this},on(y,w){return w&&"function"==typeof w&&i("add",y,w),this},trigger(A,k,H){var S;if(H=H||{cloneData:!0},A)if(y.settings.isJQueryPlugin)"remove"==A&&(A="removeTag"),jQuery(y.DOM.originalInput).triggerHandler(A,[k]);else{try{var C="object"==typeof k?k:{value:k};if((C=H.cloneData?g({},C):C).tagify=this,k.event&&(C.event=this.cloneEvent(k.event)),k instanceof Object)for(var D in k)k[D]instanceof HTMLElement&&(C[D]=k[D]);S=new CustomEvent(A,{detail:C})}catch(y){console.warn(y)}w.dispatchEvent(S)}}}}(this)),this.isFirefox=/firefox|fxios/i.test(navigator.userAgent)&&!/seamonkey/i.test(navigator.userAgent),this.isIE=window.document.documentMode,w=w||{},this.getPersistedData=(k=w.id,y=>{let w,H="/"+y;if(1==localStorage.getItem(A+k+"/v",1))try{w=JSON.parse(localStorage[A+k+H])}catch(y){}return w}),this.setPersistedData=(y=>y?(localStorage.setItem(A+y+"/v",1),(w,k)=>{let H="/"+k,S=JSON.stringify(w);w&&k&&(localStorage.setItem(A+y+H,S),dispatchEvent(new Event("storage")))}):()=>{})(w.id),this.clearPersistedData=(y=>w=>{const k=A+"/"+y+"/";if(w)localStorage.removeItem(k+w);else for(let y in localStorage)y.includes(k)&&localStorage.removeItem(y)})(w.id),this.applySettings(y,w),this.state={inputText:"",editing:!1,composing:!1,actions:{},mixMode:{},dropdown:{},flaggedTags:{}},this.value=[],this.listeners={},this.DOM={},this.build(y),b.call(this),this.getCSSVars(),this.loadOriginalValues(),this.events.customBinding.call(this),this.events.binding.call(this),y.autofocus&&this.DOM.input.focus(),y.__tagify=this}return N.prototype={_dropdown:w,getSetTagData:T,helpers:{sameStr:s,removeCollectionProp:a,omit:n,isObject:h,parseHTML:r,escapeHTML:d,extend:g,concatWithoutDups:p,getUID:m,isNodeTag:v},customEventsList:["change","add","remove","invalid","input","click","keydown","focus","blur","edit:input","edit:beforeUpdate","edit:updated","edit:start","edit:keydown","dropdown:show","dropdown:hide","dropdown:select","dropdown:updated","dropdown:noMatch","dropdown:scroll"],dataProps:["__isValid","__removed","__originalData","__originalHTML","__tagId"],trim(y){return this.settings.trim&&y&&"string"==typeof y?y.trim():y},parseHTML:r,templates:S,parseTemplate(y,w){return r((y=this.settings.templates[y]||y).apply(this,w))},set whitelist(y){const w=y&&Array.isArray(y);this.settings.whitelist=w?y:[],this.setPersistedData(w?y:[],"whitelist")},get whitelist(){return this.settings.whitelist},generateClassSelectors(y){for(let w in y){let A=w;Object.defineProperty(y,A+"Selector",{get(){return"."+this[A].split(" ")[0]}})}},applySettings(w,A){y.templates=this.templates;var k=g({},y,"mix"==A.mode?{dropdown:{position:"text"}}:{}),S=this.settings=g({},k,A);if(S.disabled=w.hasAttribute("disabled"),S.readonly=S.readonly||w.hasAttribute("readonly"),S.placeholder=d(w.getAttribute("placeholder")||S.placeholder||""),S.required=w.hasAttribute("required"),this.generateClassSelectors(S.classNames),void 0===S.dropdown.includeSelectedTags&&(S.dropdown.includeSelectedTags=S.duplicates),this.isIE&&(S.autoComplete=!1),["whitelist","blacklist"].forEach((y=>{var A=w.getAttribute("data-"+y);A&&(A=A.split(S.delimiters))instanceof Array&&(S[y]=A)})),"autoComplete"in A&&!h(A.autoComplete)&&(S.autoComplete=y.autoComplete,S.autoComplete.enabled=A.autoComplete),"mix"==S.mode&&(S.pattern=S.pattern||/@/,S.autoComplete.rightKey=!0,S.delimiters=A.delimiters||null,S.tagTextProp&&!S.dropdown.searchKeys.includes(S.tagTextProp)&&S.dropdown.searchKeys.push(S.tagTextProp)),w.pattern)try{S.pattern=new RegExp(w.pattern)}catch(w){}if(S.delimiters){S._delimiters=S.delimiters;try{S.delimiters=new RegExp(this.settings.delimiters,"g")}catch(w){}}S.disabled&&(S.userInput=!1),this.TEXTS=e(e({},H),S.texts||{}),("select"!=S.mode||A.dropdown?.enabled)&&S.userInput||(S.dropdown.enabled=0),S.dropdown.appendTarget=A.dropdown?.appendTarget||document.body;let C=this.getPersistedData("whitelist");Array.isArray(C)&&(this.whitelist=Array.isArray(S.whitelist)?p(S.whitelist,C):C)},getAttributes(y){var w,A=this.getCustomAttributes(y),k="";for(w in A)k+=" "+w+(void 0!==y[w]?`="${A[w]}"`:"");return k},getCustomAttributes(y){if(!h(y))return"";var w,A={};for(w in y)"__"!=w.slice(0,2)&&"class"!=w&&y.hasOwnProperty(w)&&void 0!==y[w]&&(A[w]=d(y[w]));return A},setStateSelection(){var y=window.getSelection(),w={anchorOffset:y.anchorOffset,anchorNode:y.anchorNode,range:y.getRangeAt&&y.rangeCount&&y.getRangeAt(0)};return this.state.selection=w,w},getCSSVars(){var y,w=getComputedStyle(this.DOM.scope,null);this.CSSVars={tagHideTransition:(y=>{let w=y.value;return"s"==y.unit?1e3*w:w})(function(y){if(!y)return{};var w=(y=y.trim().split(" ")[0]).split(/\d+/g).filter((y=>y)).pop().trim();return{value:+y.split(w).filter((y=>y))[0].trim(),unit:w}}((y="tag-hide-transition",w.getPropertyValue("--"+y))))}},build(y){var w=this.DOM;this.settings.mixMode.integrated?(w.originalInput=null,w.scope=y,w.input=y):(w.originalInput=y,w.originalInput_tabIndex=y.tabIndex,w.scope=this.parseTemplate("wrapper",[y,this.settings]),w.input=w.scope.querySelector(this.settings.classNames.inputSelector),y.parentNode.insertBefore(w.scope,y),y.tabIndex=-1)},destroy(){this.events.unbindGlobal.call(this),this.DOM.scope.parentNode.removeChild(this.DOM.scope),this.DOM.originalInput.tabIndex=this.DOM.originalInput_tabIndex,delete this.DOM.originalInput.__tagify,this.dropdown.hide(!0),clearTimeout(this.dropdownHide__bindEventsTimeout),clearInterval(this.listeners.main.originalInputValueObserverInterval)},loadOriginalValues(y){var w,A=this.settings;if(this.state.blockChangeEvent=!0,void 0===y){const w=this.getPersistedData("value");y=w&&!this.DOM.originalInput.value?w:A.mixMode.integrated?this.DOM.input.textContent:this.DOM.originalInput.value}if(this.removeAllTags(),y)if("mix"==A.mode)this.parseMixTags(y),(w=this.DOM.input.lastChild)&&"BR"==w.tagName||this.DOM.input.insertAdjacentHTML("beforeend","<br>");else{try{JSON.parse(y)instanceof Array&&(y=JSON.parse(y))}catch(y){}this.addTags(y,!0).forEach((y=>y&&y.classList.add(A.classNames.tagNoAnimation)))}else this.postUpdate();this.state.lastOriginalValueReported=A.mixMode.integrated?"":this.DOM.originalInput.value},cloneEvent(y){var w={};for(var A in y)"path"!=A&&(w[A]=y[A]);return w},loading(y){return this.state.isLoading=y,this.DOM.scope.classList[y?"add":"remove"](this.settings.classNames.scopeLoading),this},tagLoading(y,w){return y&&y.classList[w?"add":"remove"](this.settings.classNames.tagLoading),this},toggleClass(y,w){"string"==typeof y&&this.DOM.scope.classList.toggle(y,w)},toggleScopeValidation(y){var w=!0===y||void 0===y;!this.settings.required&&y&&y===this.TEXTS.empty&&(w=!0),this.toggleClass(this.settings.classNames.tagInvalid,!w),this.DOM.scope.title=w?"":y},toggleFocusClass(y){this.toggleClass(this.settings.classNames.focus,!!y)},triggerChangeEvent:function(){if(!this.settings.mixMode.integrated){var y=this.DOM.originalInput,w=this.state.lastOriginalValueReported!==y.value,A=new CustomEvent("change",{bubbles:!0});w&&(this.state.lastOriginalValueReported=y.value,A.simulated=!0,y._valueTracker&&y._valueTracker.setValue(Math.random()),y.dispatchEvent(A),this.trigger("change",this.state.lastOriginalValueReported),y.value=this.state.lastOriginalValueReported)}},events:C,fixFirefoxLastTagNoCaret(){},setRangeAtStartEnd(y,w){if(w){y="number"==typeof y?y:!!y,w=w.lastChild||w;var A=document.getSelection();if(A.focusNode instanceof Element&&!this.DOM.input.contains(A.focusNode))return!0;try{A.rangeCount>=1&&["Start","End"].forEach((k=>A.getRangeAt(0)["set"+k](w,y||w.length)))}catch(y){}}},placeCaretAfterNode(y){if(y&&y.parentNode){var w=y,A=window.getSelection(),k=A.getRangeAt(0);A.rangeCount&&(k.setStartAfter(w),k.collapse(!0),A.removeAllRanges(),A.addRange(k))}},insertAfterTag(y,w){if(w=w||this.settings.mixMode.insertAfterTag,y&&y.parentNode&&w)return w="string"==typeof w?document.createTextNode(w):w,y.parentNode.insertBefore(w,y.nextSibling),w},editTagChangeDetected(y){var w=y.__originalData;for(var A in w)if(!this.dataProps.includes(A)&&y[A]!=w[A])return!0;return!1},getTagTextNode(y){return y.querySelector(this.settings.classNames.tagTextSelector)},setTagTextNode(y,w){this.getTagTextNode(y).innerHTML=d(w)},editTag(y,w){y=y||this.getLastTag(),w=w||{},this.dropdown.hide();var A=this.settings,k=this.getTagTextNode(y),H=this.getNodeIndex(y),S=T(y),C=this.events.callbacks,D=this,I=!0;if(k){if(!(S instanceof Object&&"editable"in S)||S.editable)return S=T(y,{__originalData:g({},S),__originalHTML:y.cloneNode(!0)}),T(S.__originalHTML,S.__originalData),k.setAttribute("contenteditable",!0),y.classList.add(A.classNames.tagEditing),k.addEventListener("focus",C.onEditTagFocus.bind(this,y)),k.addEventListener("blur",(function(){setTimeout((()=>C.onEditTagBlur.call(D,D.getTagTextNode(y))))})),k.addEventListener("input",C.onEditTagInput.bind(this,k)),k.addEventListener("paste",C.onEditTagPaste.bind(this,k)),k.addEventListener("keydown",(w=>C.onEditTagkeydown.call(this,w,y))),k.addEventListener("compositionstart",C.onCompositionStart.bind(this)),k.addEventListener("compositionend",C.onCompositionEnd.bind(this)),w.skipValidation||(I=this.editTagToggleValidity(y)),k.originalIsValid=I,this.trigger("edit:start",{tag:y,index:H,data:S,isValid:I}),k.focus(),this.setRangeAtStartEnd(!1,k),this}else console.warn("Cannot find element in Tag template: .",A.classNames.tagTextSelector)},editTagToggleValidity(y,w){var A;if(w=w||T(y))return(A=!("__isValid"in w)||!0===w.__isValid)||this.removeTagsFromValue(y),this.update(),y.classList.toggle(this.settings.classNames.tagNotAllowed,!A),w.__isValid;console.warn("tag has no data: ",y,w)},onEditTagDone(y,w){w=w||{};var A={tag:y=y||this.state.editing.scope,index:this.getNodeIndex(y),previousData:T(y),data:w};this.trigger("edit:beforeUpdate",A,{cloneData:!1}),this.state.editing=!1,delete w.__originalData,delete w.__originalHTML,y&&w[this.settings.tagTextProp]?(y=this.replaceTag(y,w),this.editTagToggleValidity(y,w),this.settings.a11y.focusableTags?y.focus():this.placeCaretAfterNode(y)):y&&this.removeTags(y),this.trigger("edit:updated",A),this.dropdown.hide(),this.settings.keepInvalidTags&&this.reCheckInvalidTags()},replaceTag(y,w){w&&w.value||(w=y.__tagifyTagData),w.__isValid&&1!=w.__isValid&&g(w,this.getInvalidTagAttrs(w,w.__isValid));var A=this.createTagElem(w);return y.parentNode.replaceChild(A,y),this.updateValueByDOMTags(),A},updateValueByDOMTags(){this.value.length=0,[].forEach.call(this.getTagElms(),(y=>{y.classList.contains(this.settings.classNames.tagNotAllowed.split(" ")[0])||this.value.push(T(y))})),this.update()},injectAtCaret(y,w){return!(w=w||this.state.selection?.range)&&y?(this.appendMixTags(y),this):(f(y,w),this.setRangeAtStartEnd(!1,y),this.updateValueByDOMTags(),this.update(),this)},input:{set(){let y=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",w=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];var A=this.settings.dropdown.closeOnSelect;this.state.inputText=y,w&&(this.DOM.input.innerHTML=d(""+y)),!y&&A&&this.dropdown.hide.bind(this),this.input.autocomplete.suggest.call(this),this.input.validate.call(this)},raw(){return this.DOM.input.textContent},validate(){var y=!this.state.inputText||!0===this.validateTag({value:this.state.inputText});return this.DOM.input.classList.toggle(this.settings.classNames.inputInvalid,!y),y},normalize(y){var w=y||this.DOM.input,A=[];w.childNodes.forEach((y=>3==y.nodeType&&A.push(y.nodeValue))),A=A.join("\n");try{A=A.replace(/(?:\r\n|\r|\n)/g,this.settings.delimiters.source.charAt(0))}catch(y){}return A=A.replace(/\s/g," "),this.trim(A)},autocomplete:{suggest(y){if(this.settings.autoComplete.enabled){"string"==typeof(y=y||{value:""})&&(y={value:y});var w=this.dropdown.getMappedValue(y);if("number"!=typeof w){var A=w.substr(0,this.state.inputText.length).toLowerCase(),k=w.substring(this.state.inputText.length);w&&this.state.inputText&&A==this.state.inputText.toLowerCase()?(this.DOM.input.setAttribute("data-suggest",k),this.state.inputSuggestion=y):(this.DOM.input.removeAttribute("data-suggest"),delete this.state.inputSuggestion)}}},set(y){var w=this.DOM.input.getAttribute("data-suggest"),A=y||(w?this.state.inputText+w:null);return!!A&&("mix"==this.settings.mode?this.replaceTextWithNode(document.createTextNode(this.state.tag.prefix+A)):(this.input.set.call(this,A),this.setRangeAtStartEnd(!1,this.DOM.input)),this.input.autocomplete.suggest.call(this),this.dropdown.hide(),!0)}}},getTagIdx(y){return this.value.findIndex((w=>w.__tagId==(y||{}).__tagId))},getNodeIndex(y){var w=0;if(y)for(;y=y.previousElementSibling;)w++;return w},getTagElms(){for(var y=arguments.length,w=new Array(y),A=0;A<y;A++)w[A]=arguments[A];var k="."+[...this.settings.classNames.tag.split(" "),...w].join(".");return[].slice.call(this.DOM.scope.querySelectorAll(k))},getLastTag(){var y=this.DOM.scope.querySelectorAll(`${this.settings.classNames.tagSelector}:not(.${this.settings.classNames.tagHide}):not([readonly])`);return y[y.length-1]},isTagDuplicate(y,w,A){var k=0;if("select"==this.settings.mode)return!1;for(let H of this.value)s(this.trim(""+y),H.value,w)&&A!=H.__tagId&&k++;return k},getTagIndexByValue(y){var w=[];return this.getTagElms().forEach(((A,k)=>{s(this.trim(A.textContent),y,this.settings.dropdown.caseSensitive)&&w.push(k)})),w},getTagElmByValue(y){var w=this.getTagIndexByValue(y)[0];return this.getTagElms()[w]},flashTag(y){y&&(y.classList.add(this.settings.classNames.tagFlash),setTimeout((()=>{y.classList.remove(this.settings.classNames.tagFlash)}),100))},isTagBlacklisted(y){return y=this.trim(y.toLowerCase()),this.settings.blacklist.filter((w=>(""+w).toLowerCase()==y)).length},isTagWhitelisted(y){return!!this.getWhitelistItem(y)},getWhitelistItem(y,w,A){w=w||"value";var k,H=this.settings;return(A=A||H.whitelist).some((A=>{var S="string"==typeof A?A:A[w]||A.value;if(s(S,y,H.dropdown.caseSensitive,H.trim))return k="string"==typeof A?{value:A}:A,!0})),k||"value"!=w||"value"==H.tagTextProp||(k=this.getWhitelistItem(y,H.tagTextProp,A)),k},validateTag(y){var w=this.settings,A="value"in y?"value":w.tagTextProp,k=this.trim(y[A]+"");return(y[A]+"").trim()?w.pattern&&w.pattern instanceof RegExp&&!w.pattern.test(k)?this.TEXTS.pattern:!w.duplicates&&this.isTagDuplicate(k,w.dropdown.caseSensitive,y.__tagId)?this.TEXTS.duplicate:this.isTagBlacklisted(k)||w.enforceWhitelist&&!this.isTagWhitelisted(k)?this.TEXTS.notAllowed:!w.validate||w.validate(y):this.TEXTS.empty},getInvalidTagAttrs(y,w){return{"aria-invalid":!0,class:`${y.class||""} ${this.settings.classNames.tagNotAllowed}`.trim(),title:w}},hasMaxTags(){return this.value.length>=this.settings.maxTags&&this.TEXTS.exceed},setReadonly(y,w){var A=this.settings;document.activeElement.blur(),A[w||"readonly"]=y,this.DOM.scope[(y?"set":"remove")+"Attribute"](w||"readonly",!0),this.setContentEditable(!y)},setContentEditable(y){this.settings.userInput&&(this.DOM.input.contentEditable=y,this.DOM.input.tabIndex=y?0:-1)},setDisabled(y){this.setReadonly(y,"disabled")},normalizeTags(y){var w=this.settings,A=w.whitelist,k=w.delimiters,H=w.mode,S=w.tagTextProp,C=[],D=!!A&&A[0]instanceof Object,I=Array.isArray(y),x=I&&y[0].value,h=y=>(y+"").split(k).filter((y=>y)).map((y=>({[S]:this.trim(y),value:this.trim(y)})));if("number"==typeof y&&(y=y.toString()),"string"==typeof y){if(!y.trim())return[];y=h(y)}else I&&(y=[].concat(...y.map((y=>null!=y.value?y:h(y)))));return D&&!x&&(y.forEach((y=>{var w=C.map((y=>y.value)),A=this.dropdown.filterListItems.call(this,y[S],{exact:!0});this.settings.duplicates||(A=A.filter((y=>!w.includes(y.value))));var k=A.length>1?this.getWhitelistItem(y[S],S,A):A[0];k&&k instanceof Object?C.push(k):"mix"!=H&&(null==y.value&&(y.value=y[S]),C.push(y))})),C.length&&(y=C)),y},parseMixTags(y){var w=this.settings,A=w.mixTagsInterpolator,k=w.duplicates,H=w.transformTag,S=w.enforceWhitelist,C=w.maxTags,D=w.tagTextProp,I=[];return y=y.split(A[0]).map(((y,w)=>{var x,E,M,O=y.split(A[1]),L=O[0],U=I.length==C;try{if(L==+L)throw Error;E=JSON.parse(L)}catch(y){E=this.normalizeTags(L)[0]||{value:L}}if(H.call(this,E),U||!(O.length>1)||S&&!this.isTagWhitelisted(E.value)||!k&&this.isTagDuplicate(E.value)){if(y)return w?A[0]+y:y}else E[x=E[D]?D:"value"]=this.trim(E[x]),M=this.createTagElem(E),I.push(E),M.classList.add(this.settings.classNames.tagNoAnimation),O[0]=M.outerHTML,this.value.push(E);return O.join("")})).join(""),this.DOM.input.innerHTML=y,this.DOM.input.appendChild(document.createTextNode("")),this.DOM.input.normalize(),this.getTagElms().forEach(((y,w)=>T(y,I[w]))),this.update({withoutChangeEvent:!0}),y},replaceTextWithNode(y,w){if(this.state.tag||w){w=w||this.state.tag.prefix+this.state.tag.value;var A,k,H=this.state.selection||window.getSelection(),S=H.anchorNode,C=this.state.tag.delimiters?this.state.tag.delimiters.length:0;return S.splitText(H.anchorOffset-C),-1==(A=S.nodeValue.lastIndexOf(w))||(k=S.splitText(A),y&&S.parentNode.replaceChild(y,k)),!0}},selectTag(y,w){var A=this.settings;if(!A.enforceWhitelist||this.isTagWhitelisted(w.value)){this.input.set.call(this,w[A.tagTextProp]||w.value,!0),this.state.actions.selectOption&&setTimeout((()=>this.setRangeAtStartEnd(!1,this.DOM.input)));var k=this.getLastTag();return k?this.replaceTag(k,w):this.appendTag(y),this.value[0]=w,this.update(),this.trigger("add",{tag:y,data:w}),[y]}},addEmptyTag(y){var w=g({value:""},y||{}),A=this.createTagElem(w);T(A,w),this.appendTag(A),this.editTag(A,{skipValidation:!0})},addTags(y,w,A){var k=[],H=this.settings,S=[],C=document.createDocumentFragment();if(A=A||H.skipInvalid,!y||0==y.length)return k;switch(y=this.normalizeTags(y),H.mode){case"mix":return this.addMixTags(y);case"select":w=!1,this.removeAllTags()}return this.DOM.input.removeAttribute("style"),y.forEach((y=>{var w,D={},I=Object.assign({},y,{value:y.value+""});if(y=Object.assign({},I),H.transformTag.call(this,y),y.__isValid=this.hasMaxTags()||this.validateTag(y),!0!==y.__isValid){if(A)return;if(g(D,this.getInvalidTagAttrs(y,y.__isValid),{__preInvalidData:I}),y.__isValid==this.TEXTS.duplicate&&this.flashTag(this.getTagElmByValue(y.value)),!H.createInvalidTags)return void S.push(y.value)}if("readonly"in y&&(y.readonly?D["aria-readonly"]=!0:delete y.readonly),w=this.createTagElem(y,D),k.push(w),"select"==H.mode)return this.selectTag(w,y);C.appendChild(w),y.__isValid&&!0===y.__isValid?(this.value.push(y),this.trigger("add",{tag:w,index:this.value.length-1,data:y})):(this.trigger("invalid",{data:y,index:this.value.length,tag:w,message:y.__isValid}),H.keepInvalidTags||setTimeout((()=>this.removeTags(w,!0)),1e3)),this.dropdown.position()})),this.appendTag(C),this.update(),y.length&&w&&(this.input.set.call(this,H.createInvalidTags?"":S.join(H._delimiters)),this.setRangeAtStartEnd(!1,this.DOM.input)),H.dropdown.enabled&&this.dropdown.refilter(),k},addMixTags(y){if((y=this.normalizeTags(y))[0].prefix||this.state.tag)return this.prefixedTextToTag(y[0]);var w=document.createDocumentFragment();return y.forEach((y=>{var A=this.createTagElem(y);w.appendChild(A)})),this.appendMixTags(w),w},appendMixTags(y){var w=!!this.state.selection;w?this.injectAtCaret(y):(this.DOM.input.focus(),(w=this.setStateSelection()).range.setStart(this.DOM.input,w.range.endOffset),w.range.setEnd(this.DOM.input,w.range.endOffset),this.DOM.input.appendChild(y),this.updateValueByDOMTags(),this.update())},prefixedTextToTag(y){var w,A=this.settings,k=this.state.tag.delimiters;if(A.transformTag.call(this,y),y.prefix=y.prefix||this.state.tag?this.state.tag.prefix:(A.pattern.source||A.pattern)[0],w=this.createTagElem(y),this.replaceTextWithNode(w)||this.DOM.input.appendChild(w),setTimeout((()=>w.classList.add(this.settings.classNames.tagNoAnimation)),300),this.value.push(y),this.update(),!k){var H=this.insertAfterTag(w)||w;setTimeout(this.placeCaretAfterNode,0,H)}return this.state.tag=null,this.trigger("add",g({},{tag:w},{data:y})),w},appendTag(y){var w=this.DOM,A=w.input;w.scope.insertBefore(y,A)},createTagElem(y,w){y.__tagId=m();var A,k=g({},y,e({value:d(y.value+"")},w));return function(y){for(var w,A=document.createNodeIterator(y,NodeFilter.SHOW_TEXT,null,!1);w=A.nextNode();)w.textContent.trim()||w.parentNode.removeChild(w)}(A=this.parseTemplate("tag",[k,this])),T(A,y),A},reCheckInvalidTags(){var y=this.settings;this.getTagElms(y.classNames.tagNotAllowed).forEach(((w,A)=>{var k=T(w),H=this.hasMaxTags(),S=this.validateTag(k),C=!0===S&&!H;if("select"==y.mode&&this.toggleScopeValidation(S),C)return k=k.__preInvalidData?k.__preInvalidData:{value:k.value},this.replaceTag(w,k);w.title=H||S}))},removeTags(y,w,A){var k,H=this.settings;if(y=y&&y instanceof HTMLElement?[y]:y instanceof Array?y:y?[y]:[this.getLastTag()],k=y.reduce(((y,w)=>{w&&"string"==typeof w&&(w=this.getTagElmByValue(w));var A=T(w);return w&&A&&!A.readonly&&y.push({node:w,idx:this.getTagIdx(A),data:T(w,{__removed:!0})}),y}),[]),A="number"==typeof A?A:this.CSSVars.tagHideTransition,"select"==H.mode&&(A=0,this.input.set.call(this)),1==k.length&&"select"!=H.mode&&k[0].node.classList.contains(H.classNames.tagNotAllowed)&&(w=!0),k.length)return H.hooks.beforeRemoveTag(k,{tagify:this}).then((()=>{function t(y){y.node.parentNode&&(y.node.parentNode.removeChild(y.node),w?H.keepInvalidTags&&this.trigger("remove",{tag:y.node,index:y.idx}):(this.trigger("remove",{tag:y.node,index:y.idx,data:y.data}),this.dropdown.refilter(),this.dropdown.position(),this.DOM.input.normalize(),H.keepInvalidTags&&this.reCheckInvalidTags()))}A&&A>10&&1==k.length?function(y){y.node.style.width=parseFloat(window.getComputedStyle(y.node).width)+"px",document.body.clientTop,y.node.classList.add(H.classNames.tagHide),setTimeout(t.bind(this),A,y)}.call(this,k[0]):k.forEach(t.bind(this)),w||(this.removeTagsFromValue(k.map((y=>y.node))),this.update(),"select"==H.mode&&this.setContentEditable(!0))})).catch((y=>{}))},removeTagsFromDOM(){[].slice.call(this.getTagElms()).forEach((y=>y.parentNode.removeChild(y)))},removeTagsFromValue(y){(y=Array.isArray(y)?y:[y]).forEach((y=>{var w=T(y),A=this.getTagIdx(w);A>-1&&this.value.splice(A,1)}))},removeAllTags(y){y=y||{},this.value=[],"mix"==this.settings.mode?this.DOM.input.innerHTML="":this.removeTagsFromDOM(),this.dropdown.refilter(),this.dropdown.position(),this.state.dropdown.visible&&setTimeout((()=>{this.DOM.input.focus()})),"select"==this.settings.mode&&(this.input.set.call(this),this.setContentEditable(!0)),this.update(y)},postUpdate(){this.state.blockChangeEvent=!1;var y=this.settings,w=y.classNames,A="mix"==y.mode?y.mixMode.integrated?this.DOM.input.textContent:this.DOM.originalInput.value.trim():this.value.length+this.input.raw.call(this).length;this.toggleClass(w.hasMaxTags,this.value.length>=y.maxTags),this.toggleClass(w.hasNoTags,!this.value.length),this.toggleClass(w.empty,!A),"select"==y.mode&&this.toggleScopeValidation(this.value?.[0]?.__isValid)},setOriginalInputValue(y){var w=this.DOM.originalInput;this.settings.mixMode.integrated||(w.value=y,w.tagifyValue=w.value,this.setPersistedData(y,"value"))},update(y){clearTimeout(this.debouncedUpdateTimeout),this.debouncedUpdateTimeout=setTimeout(function(){var w=this.getInputValue();this.setOriginalInputValue(w),this.settings.onChangeAfterBlur&&(y||{}).withoutChangeEvent||this.state.blockChangeEvent||this.triggerChangeEvent(),this.postUpdate()}.bind(this),100)},getInputValue(){var y=this.getCleanValue();return"mix"==this.settings.mode?this.getMixedTagsAsString(y):y.length?this.settings.originalInputValueFormat?this.settings.originalInputValueFormat(y):JSON.stringify(y):""},getCleanValue(y){return a(y||this.value,this.dataProps)},getMixedTagsAsString(){var y="",w=this,A=this.settings,k=A.originalInputValueFormat||JSON.stringify,H=A.mixTagsInterpolator;return function i(A){A.childNodes.forEach((A=>{if(1==A.nodeType){const S=T(A);if("BR"==A.tagName&&(y+="\r\n"),S&&v.call(w,A)){if(S.__removed)return;y+=H[0]+k(n(S,w.dataProps))+H[1]}else A.getAttribute("style")||["B","I","U"].includes(A.tagName)?y+=A.textContent:"DIV"!=A.tagName&&"P"!=A.tagName||(y+="\r\n",i(A))}else y+=A.textContent}))}(this.DOM.input),y}},N.prototype.removeTag=N.prototype.removeTags,N}());class TagDialog extends FormApplication{tagify=null;dragSort=null;constructor(y){super(y,{title:y.title}),this.content=y.content,this.submit=y.submit,this.categoryId=null,this.subcategoryId=null}static get defaultOptions(){const y=super.defaultOptions;return foundry.utils.mergeObject(y,{classes:["tah-dialog","sheet"],closeOnSubmit:!0,id:"token-action-hud-dialog",popOut:!0,resizable:!0,height:"auto",width:600})}getData(y){return this.content}activateListeners(y){super.activateListeners(y);y.find("#tah-form-cancel").on("click",this.close.bind(this));y.find("#tah-dialog-reset-actions").on("click",this.#R)}static showDialog(y,w,A,k,H){this.nestId=w,TagDialog._prepareHook(A);const S={title:k.title,content:k.content,submit:H};let C;switch(y){case"hud":C=new TagDialogHud(S);break;case"topLevelGroup":C=new TagDialogTopLevelGroup(S);break;case"group":C=new TagDialogGroup(S)}C.render(!0)}static _prepareHook(y){Hooks.once("renderTagDialog",((w,A,k)=>{const H=A.find('input[class="tah-dialog-tagify"]');if(H.length>0){const S={delimiters:";",maxTags:"Infinity",dropdown:{position:"manual",maxItems:1/0,classname:"tah-dialog-tags-dropdown",enabled:0},templates:{dropdownItemNoMatch:()=>"<div class='empty'>Nothing Found</div>"}};function onDragEnd(y){TagDialog.tagify.updateValueByDOMTags()}y.available&&(S.whitelist=y.available),console.log("!! tag-dialog - 0"),TagDialog.tagify=new P(H[0],S),console.log("!! tag-dialog - 1"),y.selected&&TagDialog.tagify.addTags(y.selected),TagDialog.dragSort=new U(TagDialog.tagify.DOM.scope,{selector:"."+TagDialog.tagify.settings.classNames.tag,callbacks:{dragEnd:onDragEnd}}),A.find(".tagify__input").on("keydown",(y=>{"Enter"===y.key&&(y.preventDefault(),TagDialog.tagify.addTags(TagDialog.tagify.state.inputText,!0))}));if(A.find("#tah-dialog-unselect-all").on("click",TagDialog.tagify.removeAllTags.bind(TagDialog.tagify)),"TagDialogHud"===w.constructor.name)return;TagDialog.tagify.dropdown.show();const C=document.createElement("div");C.classList.add("tah-dialog-label"),C.innerHTML=Utils.i18n("tokenActionHud.form.hud.availableItems"),TagDialog.tagify.DOM.scope.parentNode.appendChild(C),TagDialog.tagify.DOM.scope.parentNode.appendChild(TagDialog.tagify.DOM.dropdown)}})),Hooks.on("renderApplication",((y,w,A)=>{y.constructor.name.startsWith("TagDialog")&&(y.setPosition(),y.setPosition({top:50}))}))}async#R(){new Dialog({title:Utils.i18n("tokenActionHud.dialog.resetActions.title"),content:`<p>${Utils.i18n("tokenActionHud.dialog.resetActions.content")}</p>`,buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:Utils.i18n("tokenActionHud.dialog.button.yes"),callback:async()=>{await game.tokenActionHud.resetActorData(),Logger.info("Actions reset",!0)}},no:{icon:'<i class="fas fa-times"></i>',label:Utils.i18n("tokenActionHud.dialog.button.no")}}}).render(!0)}_onKeyDown(y){if("Escape"===y.key&&!y.target.className.includes("tagify"))return y.preventDefault(),y.stopPropagation(),this.close();if("Enter"===y.key&&this.data.default&&!y.target.className.includes("tagify")){y.preventDefault(),y.stopPropagation();const w=this.data.buttons[this.data.default];return this.submit(w)}}async _updateObject(y,w){const A=TagDialog.tagify.value.map((y=>(y.id=y.id??y.value.slugify({replacement:"-",strict:!0}),{id:y.id,listName:y.value,name:y.name??y.value,type:y.type})));await this.submit(A,w)}}class TagDialogHud extends TagDialog{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:A.tagDialogHud})}}class TagDialogTopLevelGroup extends TagDialog{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:A.tagDialogTopLevelGroup,tabs:[{navSelector:".tabs",contentSelector:"form",initial:"groups"}]})}}class TagDialogGroup extends TagDialog{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:A.tagDialogGroup,tabs:[{navSelector:".tabs",contentSelector:"form",initial:"groups"}]})}}class TagDialogHelper{static async showHudDialog(y){const w={available:[]};w.selected=await y.getSelectedGroups();const A=await Utils.getSetting("grid"),k={title:Utils.i18n("tokenActionHud.form.hud.hudTitle"),content:{topLabel:Utils.i18n("tokenActionHud.form.hud.hudDetail"),placeholder:Utils.i18n("tokenActionHud.form.hud.tagPlaceholder"),settings:{grid:A}}};TagDialog.showDialog("hud",null,w,k,(async(w,A)=>{const k=A?.grid;await y.updateGroups(w,{level:0}),await y.saveGroups({saveActor:!0,saveUser:!0}),await Utils.setSetting("grid",k),Hooks.callAll("forceUpdateTokenActionHud")}))}static async showGroupDialog(y,w){const{nestId:A,name:k,level:H}=w,S={};S.available=await y.getAvailableGroups({nestId:A,level:H}),S.selected=await y.getSelectedGroups({nestId:A,level:H});const C={title:Utils.i18n("tokenActionHud.form.hud.groupTitle")+` (${k})`,content:{topLabel:Utils.i18n("tokenActionHud.form.hud.groupDetail"),placeholder:Utils.i18n("tokenActionHud.form.hud.tagPlaceholder"),settings:await y.getGroupSettings(w)}};TagDialog.showDialog("topLevelGroup",A,S,C,(async(A,k)=>{A=A.map((y=>(y.id=y.id??y.name.slugify({replacement:"-",strict:!0}),y.type=y.type??"custom",{id:y.id,listName:y.listName,name:y.name,type:y.type})));const H=k?.characterCount,S=k?.customWidth,C=k?.grid,D=k?.image,I=k?.showTitle,x=k?.sort;w.settings={characterCount:H,customWidth:S,grid:C,image:D,showTitle:I,sort:x},await y.updateGroups(A,w),await y.saveGroups({saveActor:!0,saveUser:!0}),Hooks.callAll("forceUpdateTokenActionHud")}))}static async showActionDialog(y,w){const{nestId:A,name:k,level:H}=w,S={},C=await y.getAvailableActions(w),D=await y.getAvailableGroups({nestId:A,level:H});S.available=[...C,...D];const I=await y.getSelectedActions(w),x=await y.getSelectedGroups({nestId:A,level:H});S.selected=[...I,...x];const E={title:`${Utils.i18n("tokenActionHud.form.hud.groupTitle")} (${k})`,content:{topLabel:Utils.i18n("tokenActionHud.form.hud.groupDetail"),placeholder:Utils.i18n("tokenActionHud.form.hud.tagPlaceholder"),settings:await y.getGroupSettings(w)}};TagDialog.showDialog("group",A,S,E,(async(A,k)=>{const H=[],S=[];for(const y of A)"action"===y.type?S.push(y):H.push(y);const C=k?.characterCount,D=k?.collapse,I=k?.grid,x=k?.image,E=k?.showTitle,M=k?.sort,O=k?.style;w.settings={characterCount:C,collapse:D,grid:I,image:x,showTitle:E,sort:M,style:O},await y.updateGroups(H,w),await y.updateActions(S,w),await y.saveGroups({saveActor:!0,saveUser:!0}),Hooks.callAll("forceUpdateTokenActionHud")}))}}class TokenActionHud extends Application{hoveredGroups=[];defaults={};defaultHeight=200;defaultWidth=20;defaultLeftPos=150;defaultTopPos=80;leftPos=this.defaultLeftPos;topPos=this.defaultTopPos;defaultScale=1;refreshTimeout=null;rendering=!1;tokens=null;isUpdatePending=!1;isUpdating=!1;updateTimer=new Timer(10);constructor(y,w){super(),this.module=y,this.systemManager=w,this.autoDirection="down",this.directionSetting="down",this.alwaysShowSetting=!1,this.clickOpenCategorySetting=!1,this.isCollapsed=!1,this.enableCustomizationSetting=!1,this.dragSetting="whenUnlocked",this.enableSetting=!1,this.isHudEnabled=!1,this.gridSetting=!1,this.isUnlocked=!1,this.styleSetting=null}async init(){this.activeCssAsTextSetting=Utils.getSetting("activeCssAsTextSetting"),this.allowSetting=Utils.getSetting("allow"),this.alwaysShowSetting=Utils.getSetting("alwaysShowHud"),this.clickOpenCategorySetting=Utils.getSetting("clickOpenCategory"),this.customLayoutSetting=Utils.getSetting("customLayout"),this.directionSetting=Utils.getSetting("direction"),this.debugSetting=Utils.getSetting("debug"),this.displayIconsSetting=Utils.getSetting("displayIcons"),this.dragSetting=Utils.getSetting("drag"),this.enableCustomizationSetting=Utils.getSetting("enableCustomization"),this.enableSetting=Utils.getSetting("enable"),this.gridSetting=Utils.getSetting("grid"),this.scaleSetting=Utils.getSetting("scale"),this.styleSetting=Utils.getSetting("style"),this.isCollapsed=Utils.getUserFlag("isCollapsed"),this.isHudEnabled=this.#V(),this.hudPosition=Utils.getUserFlag("position"),this.isUnlocked=Utils.getUserFlag("isUnlocked"),await this.systemManager.registerDefaultFlags(),this.actionHandler=await this.systemManager.getActionHandler(),this.customLayoutSetting&&Utils.isGmActive()&&(this.actionHandler.customLayout=await DataHandler.getDataAsGm({file:this.customLayoutSetting})),this.actionHandler.enableCustomizationSetting=this.enableCustomizationSetting,this.actionHandler.displayCharacterNameSetting=Utils.getSetting("displayCharacterName"),this.actionHandler.tooltipsSetting=Utils.getSetting("tooltips"),this.categoryResizer=new CategoryResizer,this.rollHandler=this.systemManager.getRollHandler()}async updateSettings(y,w=null){this.updateSettingsPending||(this.updateSettingsPending=!0,Logger.debug("Updating settings..."));const A=O[y].variable;switch(A&&(this[A]=w),y){case"allow":case"enable":this.isHudEnabled=this.#V();break;case"customLayout":this.customLayoutSetting&&Utils.isGmActive()?(this.actionHandler.customLayoutSetting=this.customLayoutSetting,this.actionHandler.customLayout=await DataHandler.getDataAsGm({file:this.customLayoutSetting})):(this.actionHandler.customLayoutSetting=null,this.actionHandler.customLayout=null);break;case"enableCustomization":this.actionHandler.enableCustomizationSetting=w;break;case"rollHandler":this.updateRollHandler();break;case"tooltips":this.actionHandler.tooltipsSetting=w}}updateRollHandler(){this.rollHandler=this.systemManager.getRollHandler()}setTokens(y){this.tokens=y}static get defaultOptions(){return mergeObject(super.defaultOptions,{template:A.hud,id:"token-action-hud",classes:[],width:this.defaultWidth,height:this.defaultHeight,left:this.defaultLeftPos,top:this.defaultTopPos,scale:this.defaultScale,background:"none",popOut:!1,minimizable:!1,resizable:!1,title:"token-action-hud",dragDrop:[],tabs:[],scrollY:[],zIndex:100})}#j(){return"always"===this.dragSetting||"whenUnlocked"===this.dragSetting&&this.isUnlocked}#z(){const y=parseFloat(this.scaleSetting);return y<.5?.5:y>2?2:y}getData(y={}){const w=super.getData();return w.hud=this.hud,w.id="token-action-hud",w.style=D[this.styleSetting].class,w.scale=this.#z(),w.background="#00000000",Logger.debug("Application data",{data:w}),w}activateListeners(y){const w={action:y.find(".tah-action"),buttons:y.find("#tah-buttons"),tabGroup:y.find(".tah-tab-group"),groups:y.find("#tah-groups"),editHudButton:y.find("#tah-edit-hud"),listGroups:y.find(".tah-list-groups"),group:y.find(".tah-group"),subtitle:y.find(".tah-subtitle"),groupButton:y.find(".tah-group-button"),collapseHudButton:y.find("#tah-collapse-hud"),expandHudButton:y.find("#tah-expand-hud"),unlockButton:y.find("#tah-unlock"),lockButton:y.find("#tah-lock")};this.#W(w),this.#q(w),this.#K(w),this.#X(w),this.#Y(w)}postRender(){if(this.#J(),this.hoveredGroups.length)for(const y of this.hoveredGroups){const w=document.querySelector(`#${y}`);this.categoryResizer.resizeCategory(this.actionHandler,w,this.autoDirection,this.gridSetting)}}#W(y){const closeGroup=y=>{if(game.tokenActionHud.rendering)return;const w=this.clickOpenCategorySetting?y.currentTarget.parentElement:y.currentTarget;w.classList.remove("hover");const A=w.closest(".tah-group");let k=A?.nextElementSibling;for(;k;)k.classList.contains("tah-group")&&k.classList.remove("tah-hidden"),k=k.nextElementSibling;this.#Q(w.id)},openGroup=async y=>{const w=this.clickOpenCategorySetting?y.currentTarget.parentElement:y.currentTarget;w.classList.add("hover");const A=w.closest(".tah-group");let k=A?.nextElementSibling;for(;k;)k.classList.contains("tah-group")&&k.classList.add("tah-hidden"),k=k.nextElementSibling;this.categoryResizer.resizeCategory(this.actionHandler,w,this.autoDirection,this.gridSetting),this.#Z(w.id)},toggleGroup=y=>{const w=y.currentTarget.parentElement;if(w.classList.contains("hover"))closeGroup(y);else{const A=w.parentElement.querySelectorAll(".tah-tab-group");for(const y of A)y.classList.remove("hover"),this.#Q(y.id);openGroup(y)}y.currentTarget.blur()};y.groupButton.on("click",(y=>{this.bringToTop(),y.currentTarget.blur()})),this.clickOpenCategorySetting?y.groupButton.on("click",toggleGroup):(y.tabGroup.get().forEach((y=>{y.addEventListener("touchstart",toggleGroup,{passive:!0})})),y.tabGroup.hover(openGroup,closeGroup)),y.groupButton.on("mousedown",(y=>this.#tt(y))),y.groupButton.get().forEach((y=>{y.addEventListener("touchstart",(y=>this.#tt(y)),{passive:!0})}));const openGroupDialog=y=>{const w=y.currentTarget;if(!w?.parentElement?.dataset?.nestId)return;const A=w?.parentElement?.dataset?.nestId,k=w?.parentElement?.dataset?.name??w.innerText??w.outerText,H=parseInt(w?.parentElement?.dataset?.level)||null,S=w?.parentElement?.dataset?.type;TagDialogHelper.showGroupDialog(this.actionHandler,{nestId:A,name:k,level:H,type:S})};y.groupButton.on("contextmenu",(y=>{this.isUnlocked&&"1"===y.currentTarget.parentElement.dataset.level&&openGroupDialog(y)}))}#q(y){const handleAction=y=>{let w=y.target;"BUTTON"!==w.tagName&&(w=y.currentTarget.children[0]);const A=w.value;try{this.rollHandler.handleActionEvent(y,A,this.actionHandler),w.blur()}catch(w){Logger.error(y)}},openActionDialog=y=>{const w=y.target.classList.contains("tah-button-text")?y.target.closest(".tah-tab-group"):y.target.closest(".tah-group");if(!w?.dataset?.nestId)return;const A=w?.dataset?.nestId,k=y.target.innerText??y.target.outerText,H=parseInt(w?.dataset?.level)||null,S=w?.dataset?.type;TagDialogHelper.showActionDialog(this.actionHandler,{nestId:A,name:k,level:H,type:S})},collapseExpandGroup=(y,w)=>{const A=y.target.classList.contains("tah-subtitle-text")?y.target.parentElement:y.target,k=A?.closest(".tah-group"),H=k?.dataset?.nestId,S=A.closest(".tah-tab-group.hover"),C=k?.querySelector(".tah-groups"),D=A.querySelector(".tah-collapse-icon"),I=A.querySelector(".tah-expand-icon"),x=k.querySelector(".tah-list-image"),toggleGroupVisibility=()=>{C?.classList.toggle("tah-hidden"),D?.classList.toggle("tah-hidden"),I?.classList.toggle("tah-hidden"),x?.classList.toggle("tah-hidden")},saveGroupSettings=y=>{w&&this.actionHandler.saveGroupSettings({nestId:H,settings:{collapse:y}})};C?.classList.contains("tah-hidden")?(toggleGroupVisibility(),saveGroupSettings(!1),this.categoryResizer.resizeCategory(this.actionHandler,S,this.autoDirection,this.gridSetting)):(toggleGroupVisibility(),saveGroupSettings(!0))};y.subtitle.on("contextmenu",(y=>{this.isUnlocked&&openActionDialog(y)})),y.subtitle.on("click",(y=>{y.target.classList.contains("tah-button-text")||collapseExpandGroup(y,this.enableCustomizationSetting)})),y.action.on("click contextmenu",(y=>{y.preventDefault(),handleAction(y)})),y.groupButton.on("contextmenu",(y=>{this.isUnlocked&&"1"!==y.currentTarget.parentElement.dataset.level&&openActionDialog(y)}))}#K(y){y.editHudButton.on("click",(y=>{y.preventDefault(),y=y||window.event,TagDialogHelper.showHudDialog(this.actionHandler)}))}#X(y){const unlockHud=async w=>{w&&w.preventDefault();const A=w?.target||y.unlockButton;$(A).addClass("tah-hidden"),y.editHudButton.removeClass("tah-hidden"),y.group.removeClass("tah-hidden"),y.groupButton.removeClass("disable-edit"),y.groups.addClass("tah-unlocked"),y.listGroups.removeClass("tah-hidden"),y.lockButton.removeClass("tah-hidden"),y.tabGroup.removeClass("tah-hidden"),y.subtitle.removeClass("disable-edit tah-hidden"),this.isUnlocked||(await Utils.setUserFlag("isUnlocked",!0),this.isUnlocked=!0)},lockHud=async(w=null)=>{w&&w.preventDefault();const A=w?.target||y.lockButton;$(A).addClass("tah-hidden"),y.unlockButton.removeClass("tah-hidden"),y.editHudButton.addClass("tah-hidden"),y.groups.removeClass("tah-unlocked");for(const w of y.tabGroup){w.getElementsByClassName("tah-action").length>0||w.classList.add("tah-hidden")}for(const w of y.group){w.getElementsByClassName("tah-action").length>0||w.classList.add("tah-hidden")}for(const w of y.listGroups){w.getElementsByClassName("tah-action").length>0||w.classList.add("tah-hidden")}for(const w of y.subtitle){const y=w.closest(".tah-group");"false"===y?.dataset?.showTitle&&w.classList.add("tah-hidden")}y.groupButton.addClass("disable-edit"),y.subtitle.addClass("disable-edit"),this.isUnlocked&&(await Utils.setUserFlag("isUnlocked",!1),this.isUnlocked=!1)};this.isUnlocked&&this.enableCustomizationSetting?unlockHud():lockHud(),this.enableCustomizationSetting||y.unlockButton.addClass("tah-hidden"),y.unlockButton.on("click",unlockHud),y.lockButton.on("click",lockHud)}#Y(y){const collapseHud=(w=null)=>{w&&(w.preventDefault(),w=w||window.event);const A=w?.target||y.collapseHudButton;$(A).addClass("tah-hidden"),y.expandHudButton.removeClass("tah-hidden"),y.groups.addClass("tah-hidden"),y.buttons.addClass("tah-hidden"),this.isCollapsed||(Utils.setUserFlag("isCollapsed",!0),this.isCollapsed=!0)};this.isCollapsed&&collapseHud(),y.collapseHudButton.on("click",collapseHud),y.expandHudButton.on("click",(w=>{w.preventDefault(),w=w||window.event,$(w.target).addClass("tah-hidden"),y.collapseHudButton.removeClass("tah-hidden"),y.groups.removeClass("tah-hidden"),y.buttons.removeClass("tah-hidden"),this.isCollapsed&&(Utils.setUserFlag("isCollapsed",!1),this.isCollapsed=!1)})),y.expandHudButton.on("mousedown",(y=>this.#tt(y))),y.expandHudButton.get(0).addEventListener("touchstart",(y=>this.#tt(y)),{passive:!0})}#tt(y){if(!this.#j())return;const w=document.getElementById("token-action-hud"),A=y.clientX??y.changedTouches[0].clientX,k=y.clientY??y.changedTouches[0].clientY;let H=0,S=0,C=A,D=k;const I=w.offsetTop,x=w.offsetLeft;let E=I,M=x;const mouseMoveEvent=y=>{const A=y.clientX??y.changedTouches[0].clientX,k=y.clientY??y.changedTouches[0].clientY;H=C-A,S=D-k,C=A,D=k,H===C&&S===D||(E-=S,M-=H,this.topPos=E,requestAnimationFrame((()=>{Object.assign(w.style,{left:`${M}px`,position:"fixed",top:`${E}px`})})))},mouseUpEvent=()=>{document.onmousemove=null,w.ontouchmove=null,document.onmouseup=null,w.ontouchend=null,E===I&&M===x||(this.topPos=E,this.#J(),this.hudPosition={top:E,left:M},Utils.setUserFlag("position",this.hudPosition),Logger.debug(`Set position to x: ${E}px, y: ${M}px`))};document.onmousemove=mouseMoveEvent,w.ontouchmove=mouseMoveEvent,document.onmouseup=mouseUpEvent,w.ontouchend=mouseUpEvent}#et(){return"up"===this.directionSetting||"auto"===this.directionSetting&&this.topPos>window.innerHeight/2?"up":"down"}#J(){this.autoDirection=this.#et(),"up"===this.autoDirection?($(document).find(".tah-groups-container").removeClass("expand-down"),$(document).find(".tah-groups-container").addClass("expand-up"),$(document).find(".tah-groups-container").removeClass("expand-down"),$(document).find(".tah-groups-container").addClass("expand-up"),$(document).find("#tah-character-name").addClass("tah-hidden")):($(document).find(".tah-groups-container").addClass("expand-down"),$(document).find(".tah-groups-container").removeClass("expand-up"),$(document).find(".tah-groups-container").addClass("expand-down"),$(document).find(".tah-groups-container").removeClass("expand-up"),$(document).find("#tah-character-name").removeClass("tah-hidden"))}setPosition(){this.hud&&(this.#it(),this.#st(),this.rendering=!1)}#it(){if(!this.hudPosition)return;const y=this.defaultLeftPos,w=this.defaultTopPos;return new Promise((A=>{const check=()=>{const k=document.getElementById("token-action-hud");k?(k.style.bottom=null,this.topPos=this.hudPosition.top<5||this.hudPosition.top>window.innerHeight+5?w:this.hudPosition.top,k.style.top=`${this.topPos}px`,this.leftPos=this.hudPosition.left<5||this.hudPosition.left>window.innerWidth+5?y:this.hudPosition.left,k.style.left=`${this.leftPos}px`,k.style.position="fixed",A()):setTimeout(check,10)};check()}))}async resetPosition(){Logger.debug("Resetting position..."),this.hudPosition={top:this.defaultTopPos,left:this.defaultLeftPos},await Utils.setUserFlag("position",this.hudPosition),Logger.debug(`Position reset to x: ${this.defaultTopPos}px, y: ${this.defaultLeftPos}px`)}#Z(y){this.hoveredGroups.length>10&&(this.hoveredGroups=[]),this.hoveredGroups.push(y)}#Q(y){this.hoveredGroups=this.hoveredGroups.filter((w=>w!==y))}#st(){if(this.hoveredGroups.length)for(const y of this.hoveredGroups){const w=$(`#${y}`);if(w[0])if(this.clickOpenCategorySetting){w.find(".tah-group-button")[0].click()}else w.mouseenter()}}async toggleHud(){const y=Utils.humanizeBinding("toggleHud");this.enableSetting?(this.#ot(),this.enableSetting=!1,await Utils.setSetting("enable",!1),Logger.info(game.i18n.format("tokenActionHud.keybinding.toggleHud.disabled",{binding:y}),!0)):(this.enableSetting=!0,await Utils.setSetting("enable",!0),Logger.info(game.i18n.format("tokenActionHud.keybinding.toggleHud.enabled",{binding:y}),!0),Hooks.callAll("forceUpdateTokenActionHud"))}async copy(y,w){if(!game.user.isGM)return;await this.#nt(y,w)?Logger.info("HUD copied",!0):Logger.info("Copy HUD failed",!0)}async#nt(y,w){if(!y||!w.length)return!1;Logger.debug("Copying user data...");const A=await DataHandler.getDataAsGm({type:"user",id:y});if("string"==typeof w)await DataHandler.saveDataAsGm("user",w,A);else if(Array.isArray(w))for(const y of w)await DataHandler.saveDataAsGm("user",y,A);return Logger.debug("User data copied"),!0}async reset(){new Dialog({title:Utils.i18n("tokenActionHud.dialog.resetLayout.title"),content:`<p>${Utils.i18n("tokenActionHud.dialog.resetLayout.content")}</p>`,buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:Utils.i18n("tokenActionHud.dialog.button.yes"),callback:async()=>{const y=document.querySelector("#token-action-hud-core-settings input[name=customLayout]");y&&await this.updateSettings("customLayout",y?.value??""),await this.resetUserData(),this.resetPosition(),Logger.info("Layout reset",!0)}},no:{icon:'<i class="fas fa-times"></i>',label:Utils.i18n("tokenActionHud.dialog.button.no")}}}).render(!0)}async resetActorData(){Logger.debug("Resetting actor data..."),await DataHandler.saveDataAsGm("actor",this.actor.id,{}),this.actionHandler.hardResetActionHandler(),Logger.debug("Actor data reset");this.update({trigger:{type:"method",name:"TokenActionHud#resetActorData"}})}async resetAllActorData(){Logger.debug("Resetting all actor data...");for(const y of game.actors)Logger.debug(`Resetting flags for actor [${y.id}]`,{actor:y}),await DataHandler.saveDataAsGm("actor",y.id,{});this.actionHandler.hardResetActionHandler(),Logger.debug("All actor data reset");this.update({trigger:{type:"method",name:"TokenActionHud#resetAllActorData"}})}async resetUserData(){Logger.debug("Resetting user data..."),await DataHandler.saveDataAsGm("user",game.userId,{}),Logger.debug("User data reset"),this.actionHandler.hardResetActionHandler();this.update({trigger:{type:"method",name:"TokenActionHud#resetUserData"}})}async resetAllUserData(){Logger.debug("Resetting all user data...");for(const y of game.users)await DataHandler.saveDataAsGm("user",y.id,{});Logger.debug("All user data reset"),this.actionHandler.hardResetActionHandler();this.update({trigger:{type:"method",name:"TokenActionHud#resetAllUserData"}})}update(y=null){this.#at(y)}async#at(y){if("closeSettingsConfig"===y?.name&&!this.updateSettingsPending)return;this.updateSettingsPending=!1,Logger.debug("Settings updated"),this.isUpdatePending&&await this.updateTimer.abort(),this.isUpdatePending=!0,await this.updateTimer.start(),this.isUpdatePending=!1,this.isUpdating=!0,Logger.debug("Updating hud...",y);const w=this.actor?.id,A=Utils.getControlledTokens(),k=this.#rt(A),H=A.length>1&&!k;if(!k&&!H||!this.isHudEnabled)return this.#ot(),this.hoveredGroups=[],Logger.debug("Hud update aborted as no character(s) found or hud is disabled"),void(this.isUpdating=!1);const S="controlToken"===y&&w!==this.actor?.id?{saveActor:!0}:{};if(this.hud=await this.actionHandler.buildHud(S),0===this.hud.length)return this.#ot(),this.hoveredGroups=[],Logger.debug("Hud update aborted as action list empty"),void(this.isUpdating=!1);this.rendering=!0,this.render(!0),ui.windows[this.appId]||(ui.windows[this.appId]=this),this.isUpdating=!1,Hooks.callAll("tokenActionHudCoreHudUpdated",this.module),Logger.debug("Hud updated")}#ot(){this.close()}isValidTokenChange(y,w=null){return!w?.actorData?.flags&&(this.alwaysShowSetting?this.#lt(y)||y.actorId===game.user.character?.id:this.#lt(y))}#lt(y){const w=Utils.getControlledTokens();return w?.some((w=>w.id===y.id))||0===w?.length&&canvas?.tokens?.placeables?.some((y=>y.id===this.hud?.tokenId))}isValidActorOrItemUpdate(y,w){return!!this.isSelectedActor(y)&&(y?y?this.hud&&y.id===this.hud.actorId?(Logger.debug("Same actor, update hud",{actor:y,data:w}),!0):(Logger.debug("Different actor, do not update hud",{actor:y,data:w}),!1):(Logger.debug("No actor, update hud",{data:w}),!0):void 0)}isSelectedActor(y){return!y?.id||y?.id===this.actor?.id}#V(){const y=game.user.role,w=game.user.isGM;return!!this.enableSetting&&(!!w||Utils.checkAllow(y,this.allowSetting))}isLinkedCompendium(y){return Logger.debug("Compendium hook triggered, checking if compendium is linked..."),this.actionHandler.isLinkedCompendium(y)}#rt(y=[]){if(y.length>1)return this.actor=null,this.token=null,this.actionHandler.characterName="Multiple",this.actionHandler.actor=null,this.actionHandler.token=null,this.rollHandler.actor=null,this.rollHandler.token=null,null;const w={token:null,actor:null};if(1===y.length){const A=y[0],k=A.actor;if(!this.#dt(A))return null;w.token=A,w.actor=k}else 0===y.length&&game.user.character&&this.alwaysShowSetting&&(w.actor=game.user.character,w.token=canvas.tokens.placeables.find((y=>y.actor?.id===w.actor.id)));return w.actor?(this.actor=w.actor,this.token=w.token,this.actionHandler.characterName=w.token?.name??w.actor.name,this.actionHandler.actor=w.actor,this.actionHandler.token=w.token,this.rollHandler.actor=w.actor,this.rollHandler.token=w.token,w):null}#dt(y={}){const w=y?.actor,A=game.user;return game.user.isGM||w?.testUserPermission(A,"OWNER")}}let _,F,B;function sendHudToBottom(){game.tokenActionHud?.element[0]&&(game.tokenActionHud.element[0].style.zIndex=0)}Hooks.once("socketlib.ready",(()=>{B=socketlib.registerModule(y.ID),B.register("createDirectories",DataHandler.createDirectories),B.register("saveData",DataHandler.saveData),B.register("getData",DataHandler.getData)})),Hooks.on("ready",(async()=>{F=game.modules.get(y.ID),F.api={ActionListExtender:ActionListExtender,ActionHandler:ActionHandler,DataHandler:DataHandler,Logger:Logger,PreRollHandler:PreRollHandler,RollHandler:RollHandler,SystemManager:SystemManager,Timer:Timer,Utils:Utils},Hooks.callAll("tokenActionHudCoreApiReady",F)})),Hooks.on("tokenActionHudSystemReady",(async w=>{await Utils.checkModuleCompatibility(w.api.requiredCoreModuleVersion)&&(game.modules.get("socketlib")&&game.modules.get("socketlib")?.active?(_=new w.api.SystemManager(y.ID),_.registerSettings(),Utils.switchCSS(Utils.getSetting("style")),Utils.registerHandlebars(),loadTemplates([A.action,A.customStyleForm,A.group,A.hud,A.listGroup,A.settings,A.tabGroup,A.tagDialogGroup,A.tagDialogHud,A.tagDialogTopLevelGroup]),Hooks.callAll("tokenActionHudCoreReady")):Logger.error("This module requires the 'socketlib' module to be installed and enabled.",!0))})),Hooks.on("tokenActionHudCoreReady",(async()=>{if(game.user.isGM&&!game.modules.get("color-picker")?.active){!1===Utils.getSetting("startup")&&(Logger.info("To enable color pickers in this module's settings, install the 'Color Picker' module.",!0),Utils.setSetting("startup",!0))}Utils.getSetting("enableCustomization")&&game.user.isGM&&await DataHandler.createDirectories();const y=new MigrationManager(B);await y.init(),game.tokenActionHud||(game.tokenActionHud=new TokenActionHud(F,_),game.tokenActionHud.socket=B,await game.tokenActionHud.init()),game.tokenActionHud.setTokens(canvas.tokens),Hooks.on("controlToken",(async(y,w)=>{const A={type:"hook",name:"controlToken",data:[y,w]};game.tokenActionHud.update(A)})),Hooks.on("updateToken",((y,w,A)=>{if(!Object.hasOwn(w,"y")&&!Object.hasOwn(w,"x")&&game.tokenActionHud.isValidTokenChange(y,w)){const k={type:"hook",name:"updateToken",data:[y,w,A]};game.tokenActionHud.update(k)}})),Hooks.on("deleteToken",((y,w,A,k)=>{if(game.tokenActionHud.isValidTokenChange(w)){const H={type:"hook",name:"deleteToken",data:[y,w,A,k]};game.tokenActionHud.update(H)}})),Hooks.on("updateActor",((y,w)=>{if(game.tokenActionHud.isValidActorOrItemUpdate(y,w)){const A={type:"hook",name:"updateActor",data:[y,w]};game.tokenActionHud.update(A)}})),Hooks.on("deleteActor",((y,w)=>{if(game.tokenActionHud.isValidActorOrItemUpdate(y,w)){const A={type:"hook",name:"deleteActor",data:[y,w]};game.tokenActionHud.update(A)}})),Hooks.on("deleteItem",(y=>{const w=y.actor;if(game.tokenActionHud.isValidActorOrItemUpdate(w)){const w={type:"hook",name:"deleteItem",data:[y]};game.tokenActionHud.update(w)}})),Hooks.on("createItem",(y=>{const w=y.actor;if(game.tokenActionHud.isValidActorOrItemUpdate(w)){const w={type:"hook",name:"createItem",data:[y]};game.tokenActionHud.update(w)}})),Hooks.on("updateItem",(y=>{const w=y.actor;if(game.tokenActionHud.isValidActorOrItemUpdate(w)){const w={type:"hook",name:"updateItem",data:[y]};game.tokenActionHud.update(w)}})),Hooks.on("renderTokenActionHud",(()=>{game.tokenActionHud.postRender()})),Hooks.on("renderCompendium",((y,w)=>{const A=y?.metadata;if(game.tokenActionHud.isLinkedCompendium(`${A?.package}.${A?.name}`)){const A={type:"hook",name:"renderCompendium",data:[y,w]};game.tokenActionHud.update(A)}})),Hooks.on("deleteCompendium",((y,w)=>{const A=y?.metadata;if(game.tokenActionHud.isLinkedCompendium(`${A?.package}.${A?.name}`)){const A={type:"hook",name:"deleteCompendium",data:[y,w]};game.tokenActionHud.update(A)}})),Hooks.on("createCombat",(y=>{const w={type:"hook",name:"createCombat",data:[y]};game.tokenActionHud.update(w)})),Hooks.on("deleteCombat",(y=>{const w={type:"hook",name:"deleteCombat",data:[y]};game.tokenActionHud.update(w)})),Hooks.on("updateCombat",(y=>{const w={type:"hook",name:"updateCombat",data:[y]};game.tokenActionHud.update(w)})),Hooks.on("updateCombatant",((y,w,A,k)=>{if(!game.tokenActionHud.isSelectedActor(y.actor))return;const H={type:"hook",name:"updateCombatant",data:[combat,y]};game.tokenActionHud.update(H)})),Hooks.on("forceUpdateTokenActionHud",(()=>{game.tokenActionHud.update({type:"hook",name:"forceUpdateTokenActionHud"})})),Hooks.on("createActiveEffect",((y,w,A)=>{if(!game.tokenActionHud.isSelectedActor(y.parent))return;game.tokenActionHud.update({type:"hook",name:"createActiveEffect"})})),Hooks.on("deleteActiveEffect",((y,w,A)=>{if(!game.tokenActionHud.isSelectedActor(y.parent))return;game.tokenActionHud.update({type:"hook",name:"deleteActiveEffect"})})),Hooks.on("closeSettingsConfig",(()=>{game.tokenActionHud.update({type:"hook",name:"closeSettingsConfig"})}));game.tokenActionHud.update({type:"hook",name:"canvasReady"})})),Hooks.on("renderSceneNavigation",((y,w)=>{w.find("li.scene.nav-item").contextmenu((y=>{sendHudToBottom()}))})),Hooks.on("renderHotbar",((y,w)=>{w.find("li.macro").contextmenu((y=>{sendHudToBottom()}))}));export{H as ACTION_TYPE,ActionHandler,ActionListExtender,S as COMPENDIUM_ACTION_TYPES,C as COMPENDIUM_PACK_TYPES,D as CSS_STYLE,I as CUSTOM_STYLE,CategoryResizer,CompendiumActionHandler,CompendiumMacroPreHandler,CustomStyleForm,k as DELIMITER,DataHandler,x as GROUP_TYPE,GenericActionHandler,E as ITEM_MACRO_ICON,ItemMacroActionListExtender,ItemMacroPreRollHandler,M as LAYOUT_SETTING,Logger,y as MODULE,MacroActionHandler,MigrationManager,PreRollHandler,RollHandler,O as SETTING,SystemManager,A as TEMPLATE,TagDialog,TagDialogGroup,TagDialogHelper,TagDialogHud,TagDialogTopLevelGroup,TahSettingsForm,TahSettingsFormLayout,Timer,TokenActionHud,Utils,registerSettings};
